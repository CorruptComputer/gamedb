/**
 * Copyright (C) 2017 Kyle Florence
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * @website https://github.com/kflorence/jquery-deserialize/
 * @version 2.0.0-rc1
 *
 * Dual licensed under the MIT and GPLv2 licenses.
 */
(function( factory ) {
    if ( typeof module === "object" && module.exports ) {
        // Node/CommonJS
        module.exports = factory( require( "jquery" ) );

    } else {
        // Browser globals
        factory( window.jQuery );
    }
}(function( $ ) {

    /**
     * Updates a key/valueArray with the given property and value. Values will always be stored as arrays.
     *
     * @param prop The property to add the value to.
     * @param value The value to add.
     * @param obj The object to update.
     * @returns {object} Updated object.
     */
    function updateKeyValueArray( prop, value, obj ) {
        var current = obj[ prop ];

        if ( current === undefined ) {
            obj[ prop ] = [ value ];

        } else {
            current.push( value );
        }

        return obj;
    }

    /**
     * Get all of the fields contained within the given elements by name.
     *
     * @param $elements jQuery object of elements.
     * @param filter Custom filter to apply to the list of fields.
     * @returns {object} All of the fields contained within the given elements, keyed by name.
     */
    function getFieldsByName( $elements, filter ) {
        var elementsByName = {};

        // Extract fields from elements
        var fields = $elements
            .map(function convertFormToElements() {
                return this.elements ? $.makeArray( this.elements ) : this;
            })
            .filter( filter || ":input:not(:disabled)" )
            .get();

        $.each( fields, function( index, field ) {
            updateKeyValueArray( field.name, field, elementsByName );
        });

        return elementsByName;
    }

    /**
     * Figure out the type of an element. Input type will be used first, falling back to nodeName.
     *
     * @param element DOM element to check type of.
     * @returns {string} The element's type.
     */
    function getElementType( element ) {
        return ( element.type || element.nodeName ).toLowerCase();
    }

    /**
     * Normalize the provided data into a key/valueArray store.
     *
     * @param data The data provided by the user to the plugin.
     * @returns {object} The data normalized into a key/valueArray store.
     */
    function normalizeData( data ) {
        var normalized = {};
        var rPlus = /\+/g;

        // Convert data from .serializeObject() notation
        if ( $.isPlainObject( data ) ) {
            $.extend( normalized, data );

            // Convert non-array values into an array
            $.each( normalized, function( name, value ) {
                if ( !$.isArray( value ) ) {
                    normalized[ name ] = [ value ];
                }
            });

            // Convert data from .serializeArray() notation
        } else if ( $.isArray( data ) ) {
            $.each( data, function( index, field ) {
                updateKeyValueArray( field.name, field.value, normalized );
            });

            // Convert data from .serialize() notation
        } else if ( typeof data === "string" ) {
            $.each( data.split( "&" ), function( index, field ) {
                var current = field.split( "=" );
                var name = decodeURIComponent( current[ 0 ].replace( rPlus, "%20" ) );
                var value = decodeURIComponent( current[ 1 ].replace( rPlus, "%20" ) );
                updateKeyValueArray( name, value, normalized );
            });
        }

        return normalized;
    }

    /**
     * Map of property name -> element types.
     *
     * @type {object}
     */
    var updateTypes = {
        checked: [
            "radio",
            "checkbox"
        ],
        selected: [
            "option",
            "select-one",
            "select-multiple"
        ],
        value: [
            "button",
            "color",
            "date",
            "datetime",
            "datetime-local",
            "email",
            "hidden",
            "month",
            "number",
            "password",
            "range",
            "reset",
            "search",
            "submit",
            "tel",
            "text",
            "textarea",
            "time",
            "url",
            "week"
        ]
    };

    /**
     * Get the property to update on an element being updated.
     *
     * @param element The DOM element to get the property for.
     * @returns The name of the property to update if element is supported, otherwise `undefined`.
     */
    function getPropertyToUpdate( element ) {
        var type = getElementType( element );
        var elementProperty = undefined;

        $.each( updateTypes, function( property, types ) {
            if ( $.inArray( type, types ) > -1 ) {
                elementProperty = property;
                return false;
            }
        });

        return elementProperty;
    }

    /**
     * Update the element based on the provided data.
     *
     * @param element The DOM element to update.
     * @param elementIndex The index of this element in the list of elements with the same name.
     * @param value The serialized element value.
     * @param valueIndex The index of the value in the list of values for elements with the same name.
     * @param callback A function to call if the value of an element was updated.
     */
    function update( element, elementIndex, value, valueIndex, callback ) {
        var property = getPropertyToUpdate( element );

        // Handle value inputs
        // If there are multiple value inputs with the same name, they will be populated by matching indexes.
        if ( property == "value" && elementIndex == valueIndex ) {
            element.value = value;
            callback.call( element, value );

            // Handle select menus, checkboxes and radio buttons
        } else if ( property == "checked" || property == "selected" ) {
            var fields = [];

            // Extract option fields from select menus
            if ( element.options ) {
                $.each( element.options, function( index, option ) {
                    fields.push( option );
                });

            } else {
                fields.push( element );
            }

            // #37: Remove selection from multiple select menus before deserialization
            if ( element.multiple && valueIndex == 0 ) {
                element.selectedIndex = -1;
            }

            $.each( fields, function( index, field ) {
                if ( field.value == value ) {
                    field[ property ] = true;
                    callback.call( field, value );
                }
            });
        }
    }

    /**
     * Default plugin options.
     *
     * @type {object}
     */
    var defaultOptions = {
        change: $.noop,
        complete: $.noop
    };

    /**
     * The $.deserialize function.
     *
     * @param data The data to deserialize.
     * @param options Additional options.
     * @returns {jQuery} The jQuery object that was provided to the plugin.
     */
    $.fn.deserialize = function( data, options ) {

        // Backwards compatible with old arguments: data, callback
        if ( $.isFunction( options ) ) {
            options = { complete: options };
        }

        options = $.extend( defaultOptions, options || {} );
        data = normalizeData( data );

        var elementsByName = getFieldsByName( this, options.filter );

        $.each( data, function( name, values ) {
            $.each( elementsByName[ name ], function( elementIndex, element ) {
                $.each( values, function( valueIndex, value ) {
                    update( element, elementIndex, value, valueIndex, options.change );
                });
            });
        });

        options.complete.call( this );

        return this;
    };
}));
/*
 * @name DoubleScroll
 * @desc displays scroll bar on top and on the bottom of the div
 * @requires jQuery
 *
 * @author Pawel Suwala - http://suwala.eu/
 * @author Antoine Vianey - http://www.astek.fr/
 * @version 0.5 (11-11-2015)
 *
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * Usage:
 * https://github.com/avianey/jqDoubleScroll
 */
(function ($) {

    jQuery.fn.doubleScroll = function (userOptions) {

        // Default options
        var options = {
            contentElement: undefined, // Widest element, if not specified first child element will be used
            scrollCss: {
                'overflow-x': 'auto',
                'overflow-y': 'hidden',
                'height': '20px'
            },
            contentCss: {
                'overflow-x': 'auto',
                'overflow-y': 'hidden'
            },
            onlyIfScroll: true, // top scrollbar is not shown if the bottom one is not present
            resetOnWindowResize: false, // recompute the top ScrollBar requirements when the window is resized
            timeToWaitForResize: 30 // wait for the last update event (usefull when browser fire resize event constantly during ressing)
        };

        $.extend(true, options, userOptions);

        // do not modify
        // internal stuff
        $.extend(options, {
            topScrollBarMarkup: '<div class="doubleScroll-scroll-wrapper"><div class="doubleScroll-scroll"></div></div>',
            topScrollBarWrapperSelector: '.doubleScroll-scroll-wrapper',
            topScrollBarInnerSelector: '.doubleScroll-scroll'
        });

        var _showScrollBar = function ($self, options) {

            if (options.onlyIfScroll && $self.get(0).scrollWidth <= $self.width()) {
                // content doesn't scroll
                // remove any existing occurrence...
                $self.prev(options.topScrollBarWrapperSelector).remove();
                return;
            }

            // add div that will act as an upper scroll only if not already added to the DOM
            var $topScrollBar = $self.prev(options.topScrollBarWrapperSelector);

            if ($topScrollBar.length == 0) {

                // creating the scrollbar
                // added before in the DOM
                $topScrollBar = $(options.topScrollBarMarkup);
                $self.before($topScrollBar);

                // apply the css
                $topScrollBar.css(options.scrollCss);
                $(options.topScrollBarInnerSelector).css("height", "20px");
                $self.css(options.contentCss);

                // bind upper scroll to bottom scroll
                $topScrollBar.bind('scroll.doubleScroll', function () {
                    $self.scrollLeft($topScrollBar.scrollLeft());
                });

                // bind bottom scroll to upper scroll
                var selfScrollHandler = function () {
                    $topScrollBar.scrollLeft($self.scrollLeft());
                };
                $self.bind('scroll.doubleScroll', selfScrollHandler);
            }

            // find the content element (should be the widest one)
            var $contentElement;

            if (options.contentElement !== undefined && $self.find(options.contentElement).length !== 0) {
                $contentElement = $self.find(options.contentElement);
            } else {
                $contentElement = $self.find('>:first-child');
            }

            // set the width of the wrappers
            $(options.topScrollBarInnerSelector, $topScrollBar).width($contentElement.outerWidth());
            $topScrollBar.width($self.width());
            $topScrollBar.scrollLeft($self.scrollLeft());

        };

        return this.each(function () {

            var $self = $(this);

            _showScrollBar($self, options);

            // bind the resize handler
            // do it once
            if (options.resetOnWindowResize) {

                var id;
                var handler = function (e) {
                    _showScrollBar($self, options);
                };

                $(window).bind('resize.doubleScroll', function () {
                    // adding/removing/replacing the scrollbar might resize the window
                    // so the resizing flag will avoid the infinite loop here...
                    clearTimeout(id);
                    id = setTimeout(handler, options.timeToWaitForResize);
                });

            }

        });

    }

}(jQuery));

/**
 * sticky-sidebar - A JavaScript plugin for making smart and high performance.
 * @version v3.3.1
 * @link https://github.com/abouolia/sticky-sidebar
 * @author Ahmed Bouhuolia
 * @license The MIT License (MIT)
 **/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.StickySidebar=e()}(this,function(){"use strict";"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}var i=e(function(t,e){(function(t){Object.defineProperty(t,"__esModule",{value:!0});var l,n,e=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}(),i=(l=".stickySidebar",n={topSpacing:0,bottomSpacing:0,containerSelector:!1,innerWrapperSelector:".inner-wrapper-sticky",stickyClass:"is-affixed",resizeSensor:!0,minWidth:!1},function(){function c(t){var e=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,c),this.options=c.extend(n,i),this.sidebar="string"==typeof t?document.querySelector(t):t,void 0===this.sidebar)throw new Error("There is no specific sidebar element.");this.sidebarInner=!1,this.container=this.sidebar.parentElement,this.affixedType="STATIC",this.direction="down",this.support={transform:!1,transform3d:!1},this._initialized=!1,this._reStyle=!1,this._breakpoint=!1,this.dimensions={translateY:0,maxTranslateY:0,topSpacing:0,lastTopSpacing:0,bottomSpacing:0,lastBottomSpacing:0,sidebarHeight:0,sidebarWidth:0,containerTop:0,containerHeight:0,viewportHeight:0,viewportTop:0,lastViewportTop:0},["handleEvent"].forEach(function(t){e[t]=e[t].bind(e)}),this.initialize()}return e(c,[{key:"initialize",value:function(){var i=this;if(this._setSupportFeatures(),this.options.innerWrapperSelector&&(this.sidebarInner=this.sidebar.querySelector(this.options.innerWrapperSelector),null===this.sidebarInner&&(this.sidebarInner=!1)),!this.sidebarInner){var t=document.createElement("div");for(t.setAttribute("class","inner-wrapper-sticky"),this.sidebar.appendChild(t);this.sidebar.firstChild!=t;)t.appendChild(this.sidebar.firstChild);this.sidebarInner=this.sidebar.querySelector(".inner-wrapper-sticky")}if(this.options.containerSelector){var e=document.querySelectorAll(this.options.containerSelector);if((e=Array.prototype.slice.call(e)).forEach(function(t,e){t.contains(i.sidebar)&&(i.container=t)}),!e.length)throw new Error("The container does not contains on the sidebar.")}"function"!=typeof this.options.topSpacing&&(this.options.topSpacing=parseInt(this.options.topSpacing)||0),"function"!=typeof this.options.bottomSpacing&&(this.options.bottomSpacing=parseInt(this.options.bottomSpacing)||0),this._widthBreakpoint(),this.calcDimensions(),this.stickyPosition(),this.bindEvents(),this._initialized=!0}},{key:"bindEvents",value:function(){window.addEventListener("resize",this,{passive:!0,capture:!1}),window.addEventListener("scroll",this,{passive:!0,capture:!1}),this.sidebar.addEventListener("update"+l,this),this.options.resizeSensor&&"undefined"!=typeof ResizeSensor&&(new ResizeSensor(this.sidebarInner,this.handleEvent),new ResizeSensor(this.container,this.handleEvent))}},{key:"handleEvent",value:function(t){this.updateSticky(t)}},{key:"calcDimensions",value:function(){if(!this._breakpoint){var t=this.dimensions;t.containerTop=c.offsetRelative(this.container).top,t.containerHeight=this.container.clientHeight,t.containerBottom=t.containerTop+t.containerHeight,t.sidebarHeight=this.sidebarInner.offsetHeight,t.sidebarWidth=this.sidebarInner.offsetWidth,t.viewportHeight=window.innerHeight,t.maxTranslateY=t.containerHeight-t.sidebarHeight,this._calcDimensionsWithScroll()}}},{key:"_calcDimensionsWithScroll",value:function(){var t=this.dimensions;t.sidebarLeft=c.offsetRelative(this.sidebar).left,t.viewportTop=document.documentElement.scrollTop||document.body.scrollTop,t.viewportBottom=t.viewportTop+t.viewportHeight,t.viewportLeft=document.documentElement.scrollLeft||document.body.scrollLeft,t.topSpacing=this.options.topSpacing,t.bottomSpacing=this.options.bottomSpacing,"function"==typeof t.topSpacing&&(t.topSpacing=parseInt(t.topSpacing(this.sidebar))||0),"function"==typeof t.bottomSpacing&&(t.bottomSpacing=parseInt(t.bottomSpacing(this.sidebar))||0),"VIEWPORT-TOP"===this.affixedType?t.topSpacing<t.lastTopSpacing&&(t.translateY+=t.lastTopSpacing-t.topSpacing,this._reStyle=!0):"VIEWPORT-BOTTOM"===this.affixedType&&t.bottomSpacing<t.lastBottomSpacing&&(t.translateY+=t.lastBottomSpacing-t.bottomSpacing,this._reStyle=!0),t.lastTopSpacing=t.topSpacing,t.lastBottomSpacing=t.bottomSpacing}},{key:"isSidebarFitsViewport",value:function(){var t=this.dimensions,e="down"===this.scrollDirection?t.lastBottomSpacing:t.lastTopSpacing;return this.dimensions.sidebarHeight+e<this.dimensions.viewportHeight}},{key:"observeScrollDir",value:function(){var t=this.dimensions;if(t.lastViewportTop!==t.viewportTop){var e="down"===this.direction?Math.min:Math.max;t.viewportTop===e(t.viewportTop,t.lastViewportTop)&&(this.direction="down"===this.direction?"up":"down")}}},{key:"getAffixType",value:function(){this._calcDimensionsWithScroll();var t=this.dimensions,e=t.viewportTop+t.topSpacing,i=this.affixedType;return e<=t.containerTop||t.containerHeight<=t.sidebarHeight?(t.translateY=0,i="STATIC"):i="up"===this.direction?this._getAffixTypeScrollingUp():this._getAffixTypeScrollingDown(),t.translateY=Math.max(0,t.translateY),t.translateY=Math.min(t.containerHeight,t.translateY),t.translateY=Math.round(t.translateY),t.lastViewportTop=t.viewportTop,i}},{key:"_getAffixTypeScrollingDown",value:function(){var t=this.dimensions,e=t.sidebarHeight+t.containerTop,i=t.viewportTop+t.topSpacing,n=t.viewportBottom-t.bottomSpacing,o=this.affixedType;return this.isSidebarFitsViewport()?t.sidebarHeight+i>=t.containerBottom?(t.translateY=t.containerBottom-e,o="CONTAINER-BOTTOM"):i>=t.containerTop&&(t.translateY=i-t.containerTop,o="VIEWPORT-TOP"):t.containerBottom<=n?(t.translateY=t.containerBottom-e,o="CONTAINER-BOTTOM"):e+t.translateY<=n?(t.translateY=n-e,o="VIEWPORT-BOTTOM"):t.containerTop+t.translateY<=i&&0!==t.translateY&&t.maxTranslateY!==t.translateY&&(o="VIEWPORT-UNBOTTOM"),o}},{key:"_getAffixTypeScrollingUp",value:function(){var t=this.dimensions,e=t.sidebarHeight+t.containerTop,i=t.viewportTop+t.topSpacing,n=t.viewportBottom-t.bottomSpacing,o=this.affixedType;return i<=t.translateY+t.containerTop?(t.translateY=i-t.containerTop,o="VIEWPORT-TOP"):t.containerBottom<=n?(t.translateY=t.containerBottom-e,o="CONTAINER-BOTTOM"):this.isSidebarFitsViewport()||t.containerTop<=i&&0!==t.translateY&&t.maxTranslateY!==t.translateY&&(o="VIEWPORT-UNBOTTOM"),o}},{key:"_getStyle",value:function(t){if(void 0!==t){var e={inner:{},outer:{}},i=this.dimensions;switch(t){case"VIEWPORT-TOP":e.inner={position:"fixed",top:i.topSpacing,left:i.sidebarLeft-i.viewportLeft,width:i.sidebarWidth};break;case"VIEWPORT-BOTTOM":e.inner={position:"fixed",top:"auto",left:i.sidebarLeft,bottom:i.bottomSpacing,width:i.sidebarWidth};break;case"CONTAINER-BOTTOM":case"VIEWPORT-UNBOTTOM":var n=this._getTranslate(0,i.translateY+"px");e.inner=n?{transform:n}:{position:"absolute",top:i.translateY,width:i.sidebarWidth}}switch(t){case"VIEWPORT-TOP":case"VIEWPORT-BOTTOM":case"VIEWPORT-UNBOTTOM":case"CONTAINER-BOTTOM":e.outer={height:i.sidebarHeight,position:"relative"}}return e.outer=c.extend({height:"",position:""},e.outer),e.inner=c.extend({position:"relative",top:"",left:"",bottom:"",width:"",transform:""},e.inner),e}}},{key:"stickyPosition",value:function(t){if(!this._breakpoint){t=this._reStyle||t||!1,this.options.topSpacing,this.options.bottomSpacing;var e=this.getAffixType(),i=this._getStyle(e);if((this.affixedType!=e||t)&&e){var n="affix."+e.toLowerCase().replace("viewport-","")+l;for(var o in c.eventTrigger(this.sidebar,n),"STATIC"===e?c.removeClass(this.sidebar,this.options.stickyClass):c.addClass(this.sidebar,this.options.stickyClass),i.outer){var s="number"==typeof i.outer[o]?"px":"";this.sidebar.style[o]=i.outer[o]+s}for(var r in i.inner){var a="number"==typeof i.inner[r]?"px":"";this.sidebarInner.style[r]=i.inner[r]+a}var p="affixed."+e.toLowerCase().replace("viewport-","")+l;c.eventTrigger(this.sidebar,p)}else this._initialized&&(this.sidebarInner.style.left=i.inner.left);this.affixedType=e}}},{key:"_widthBreakpoint",value:function(){window.innerWidth<=this.options.minWidth?(this._breakpoint=!0,this.affixedType="STATIC",this.sidebar.removeAttribute("style"),c.removeClass(this.sidebar,this.options.stickyClass),this.sidebarInner.removeAttribute("style")):this._breakpoint=!1}},{key:"updateSticky",value:function(){var t,e=this,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this._running||(this._running=!0,t=i.type,requestAnimationFrame(function(){switch(t){case"scroll":e._calcDimensionsWithScroll(),e.observeScrollDir(),e.stickyPosition();break;case"resize":default:e._widthBreakpoint(),e.calcDimensions(),e.stickyPosition(!0)}e._running=!1}))}},{key:"_setSupportFeatures",value:function(){var t=this.support;t.transform=c.supportTransform(),t.transform3d=c.supportTransform(!0)}},{key:"_getTranslate",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return this.support.transform3d?"translate3d("+t+", "+e+", "+i+")":!!this.support.translate&&"translate("+t+", "+e+")"}},{key:"destroy",value:function(){window.removeEventListener("resize",this,{capture:!1}),window.removeEventListener("scroll",this,{capture:!1}),this.sidebar.classList.remove(this.options.stickyClass),this.sidebar.style.minHeight="",this.sidebar.removeEventListener("update"+l,this);var t={inner:{},outer:{}};for(var e in t.inner={position:"",top:"",left:"",bottom:"",width:"",transform:""},t.outer={height:"",position:""},t.outer)this.sidebar.style[e]=t.outer[e];for(var i in t.inner)this.sidebarInner.style[i]=t.inner[i];this.options.resizeSensor&&"undefined"!=typeof ResizeSensor&&(ResizeSensor.detach(this.sidebarInner,this.handleEvent),ResizeSensor.detach(this.container,this.handleEvent))}}],[{key:"supportTransform",value:function(t){var i=!1,e=t?"perspective":"transform",n=e.charAt(0).toUpperCase()+e.slice(1),o=document.createElement("support").style;return(e+" "+["Webkit","Moz","O","ms"].join(n+" ")+n).split(" ").forEach(function(t,e){if(void 0!==o[t])return i=t,!1}),i}},{key:"eventTrigger",value:function(t,e,i){try{var n=new CustomEvent(e,{detail:i})}catch(t){(n=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!0,i)}t.dispatchEvent(n)}},{key:"extend",value:function(t,e){var i={};for(var n in t)void 0!==e[n]?i[n]=e[n]:i[n]=t[n];return i}},{key:"offsetRelative",value:function(t){var e={left:0,top:0};do{var i=t.offsetTop,n=t.offsetLeft;isNaN(i)||(e.top+=i),isNaN(n)||(e.left+=n),t="BODY"===t.tagName?t.parentElement:t.offsetParent}while(t);return e}},{key:"addClass",value:function(t,e){c.hasClass(t,e)||(t.classList?t.classList.add(e):t.className+=" "+e)}},{key:"removeClass",value:function(t,e){c.hasClass(t,e)&&(t.classList?t.classList.remove(e):t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," "))}},{key:"hasClass",value:function(t,e){return t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className)}},{key:"defaults",get:function(){return n}}]),c}());t.default=i,window.StickySidebar=i})(e)});return t(i),t(e(function(t,e){(function(t){var e,s=(e=t)&&e.__esModule?e:{default:e};!function(){if("undefined"!=typeof window){var n=window.$||window.jQuery||window.Zepto,o="stickySidebar";if(n){n.fn.stickySidebar=function(i){return this.each(function(){var t=n(this),e=n(this).data(o);if(e||(e=new s.default(this,"object"==typeof i&&i),t.data(o,e)),"string"==typeof i){if(void 0===e[i]&&-1===["destroy","updateSticky"].indexOf(i))throw new Error('No method named "'+i+'"');e[i]()}})},n.fn.stickySidebar.Constructor=s.default;var t=n.fn.stickySidebar;n.fn.stickySidebar.noConflict=function(){return n.fn.stickySidebar=t,this}}}}()})(i)}))});
function isIterable(obj) {
    // checks for null and undefined
    if (obj == null) {
        return false;
    }
    return typeof obj[Symbol.iterator] === 'function';
}

function isNumeric(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}

function toast(success = true, body, title = '', timeout = 0, link = '') {

    const redirect = function () {
        if (link === 'refresh') {
            location.reload();
        }
    };

    if (timeout === 0) {
        timeout = 8;
    }

    if (timeout === -1) {
        timeout = 0;
    }

    const options = {
        onclick: link ? redirect : null,
        newestOnTop: true,
        preventDuplicates: false,
        progressBar: true,
        timeOut: timeout * 1000,
        extendedTimeOut: timeout * 1000
    };

    if (success) {
        toastr.success(body, title, options);
    } else {
        toastr.error(body, title, options);
    }
}

function highLightOwnedGames() {
    if (user.isLoggedIn) {
        let games = localStorage.getItem('games');
        if (games != null) {
            games = JSON.parse(games);
            if (games != null) {
                $('[data-app-id]').each(function () {
                    const id = $(this).attr('data-app-id');
                    if (games.indexOf(parseInt(id)) !== -1) {
                        $(this).addClass('font-weight-bold')
                    }
                });
            }
        }
    }
}

const $document = $(document);
const $body = $("body");

// Data links
let dataLinkDrag = false;
let dataLinkX = 0;
let dataLinkY = 0;

// On document for elements that are created with JS
$document.on('mousedown', '[data-link]', function (e) {
    dataLinkX = e.screenX;
    dataLinkY = e.screenY;
    dataLinkDrag = false;
});

$document.on('mousemove', '[data-link]', function handler(e) {
    if (!dataLinkDrag && (Math.abs(dataLinkX - e.screenX) > 5 || Math.abs(dataLinkY - e.screenY) > 5)) {
        dataLinkDrag = true;
    }
});

$(document).on('mouseup', '[data-link]', function (e) {

    e.stopPropagation();

    const link = $(this).attr('data-link');
    const target = $(this).attr('data-target');

    if (!link) {
        return true;
    }

    if (dataLinkDrag) {
        return true;
    }

    // Right click
    if (e.which === 3) {
        return true;
    }

    // Middle click
    if (e.ctrlKey || e.shiftKey || e.metaKey || e.which === 2 || target === '_blank') {
        if (!$(e.target).is("a")) {
            window.open(link, '_blank');
        }
        return true;
    }

    window.location.href = link;
    return true;
});

$(document).on('mouseup', '[data-link] a', function (e) {
    e.stopPropagation();
    return true;
});

$('.stop-prop').on('click', function (e) {
    e.stopPropagation();
});

// Auto dropdowns
$('.navbar .dropdown').hover(
    function () {
        $(this).addClass("show").find('.dropdown-menu').addClass("show");
    }, function () {
        $(this).removeClass("show").find('.dropdown-menu').removeClass("show");
    }
).click(function (e) {
    e.stopPropagation();
});

// Tooptips
$body.tooltip({
    selector: '[data-toggle="tooltip"]'
});

// JSON fields
function isJson(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}

$('.json').each(function (i, value) {

    const json = $(this).text();

    if (isJson(json)) {
        const jsonObj = JSON.parse(json);
        $(this).text(JSON.stringify(jsonObj, null, '  '));
    }
});

// Tabs
(function ($, window) {
    'use strict';

    $(document).ready(function () {

        // Choose tab from URL
        const hash = window.location.hash;
        if (hash) {

            let fullHash = '';
            hash.split(/[,\-]/).map(function (hash) {

                fullHash = (fullHash === '') ? hash : fullHash + '-' + hash;

                $('.nav-link[href="' + fullHash + '"]').tab('show');
            });
        }

        // Set URL from tab
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            const hash = $(e.target).attr('href');
            if (history.pushState) {
                history.pushState(null, null, hash);
            } else {
                location.hash = hash;
            }
        });
    });

})(jQuery, window);


// Scroll to top link
const $top = $("#top");

$(window).on('scroll', function (e) {

    if ($(window).scrollTop() >= 1000) {
        $top.addClass("show");
    } else {
        $top.removeClass("show");
    }
});

$top.click(function (e) {
    $('html, body').animate({scrollTop: 0}, 500);
});

highLightOwnedGames();

// Websocket helper
function websocketListener(page, onMessage) {

    if (window.WebSocket === undefined) {

        console.log('Your browser does not support websockets');

    } else {

        const socket = new WebSocket((location.protocol === 'https:' ? "wss://gamedb.online" : "ws://" + location.host) + "/websocket/" + page);
        const $badge = $('#live-badge');
        let open = false;

        socket.onopen = function (e) {
            $badge.addClass('badge-success').removeClass('badge-secondary badge-danger');
            console.log('Websocket opened');
            open = true;
        };

        socket.onclose = function (e) {
            if (open) {
                $badge.addClass('badge-danger').removeClass('badge-secondary badge-success');
                toast(false, 'Live functionality has stopped'); // onerror will trigger too
                console.log('Websocket closed');
            }
        };

        socket.onerror = function (e) {
            if (open) {
                $badge.addClass('badge-danger').removeClass('badge-secondary badge-success');
                toast(false, 'Live functionality has stopped');
            }
        };

        socket.onmessage = function (e) {
            return onMessage(e)
        };

        // Click to close websocket manually
        // $badge.on('click', function (e) {
        //     if ($(this).hasClass('cursor-pointer')) {
        //         socket.close(1000);
        //         $badge.addClass('badge-danger').removeClass('badge-secondary badge-success cursor-pointer');
        //         toast(false, 'Live functionality has stopped');
        //     }
        // });
    }
}

// Ads
// if (user.showAds) {
//
//     $('div.container').eq(1)
//         .prepend('<div class="ad-right d-none d-xl-block" id="chitikaAdBlock-0"></div>')
//         .prepend('<div class="ad-left d-none d-xl-block" id="chitikaAdBlock-1"></div>');
//     $('#ad-top')
//         .prepend('<div class="ad-top-big d-none d-lg-block d-xl-none" id="chitikaAdBlock-2"></div>')
//         .prepend('<div class="ad-top-small d-block d-lg-none" id="chitikaAdBlock-3"></div>');
// }

// Toasts
if (isIterable(user.toasts)) {
    for (const v of user.toasts) {
        toast(v.success, v.message, v.title, v.timeout, v.link);
    }
}

// Fix URLs
$(document).ready(function () {
    const path = $('#app-page, #package-page, #player-page, #bundle-page, #group-page').attr('data-path');
    if (path && path !== window.location.pathname) {
        history.replaceState(null, null, path + window.location.hash);
    }
});

function fixBrokenImages() {

    $('img').one('error', function () {

        const url = $(this).attr('data-src');
        if (url) {
            this.src = url;
        }
    });

    $('img[src=""][data-src]').each(function (i, value) {
        this.src = $(this).attr('data-src');
    });
}

// Broken images
$(document).ready(fixBrokenImages);

//
// $('div.table-responsive').doubleScroll({
//     //contentElement: undefined, // Widest element, if not specified first child element will be used
//     scrollCss: {
//         'overflow-x': 'auto',
//         'overflow-y': 'hidden'
//     },
//     contentCss: {
//         'overflow-x': 'auto',
//         'overflow-y': 'hidden'
//     },
//     onlyIfScroll: false, // top scrollbar is not shown if the bottom one is not present
//     resetOnWindowResize: false // recompute the top ScrollBar requirements when the window is resized
// });

// Local
const $dataTables = $('table.table-datatable');
const $dataTables2 = $('table.table-datatable2');
let dataTables = [];

const $lockIcon = '<i class="fa fa-lock text-muted" data-toggle="tooltip" data-placement="left" title="Private"></i>';

$dataTables.each(function (i) {

    // Find
    const disabled = [];
    $(this).find('thead tr th[data-disabled]').each(function (i) {
        disabled.push($(this).index());
    });

    // Init
    const dt = $(this).DataTable({
        "pageLength": 100,
        "paging": true,
        "ordering": true,
        "fixedHeader": true,
        "info": false,
        "searching": true,
        "search": {
            "smart": true
        },
        "autoWidth": false,
        "lengthChange": false,
        "stateSave": false,
        "dom": '<"dt-pagination"p>t<"dt-pagination"p>',
        "columnDefs": [
            {
                "targets": disabled,
                "orderable": false
            }
        ],
        "drawCallback": function (settings, json) {

            const api = this.api();
            if (api.page.info().pages <= 1) {
                $(this).parent().find('.dt-pagination').hide();
            }
        },
        "initComplete": function (settings, json) {

            $('table.table-datatable').on('order.dt', function (e, settings, processing) {

                $('#live-badge').trigger('click');

            });
        }
    });

    dataTables.push(dt);

});

// Local search
const $searchField = $('input#search');
$searchField.on('keyup', function (e) {
    $dataTables.DataTable().search($(this).val()).draw();
});

$searchField.on('keyup', function (e) {
    if ($(this).val() && e.key === "Escape") {
        $(this).val('');
        $dataTables.DataTable().search($(this).val()).draw();
        $dataTables2.DataTable().search($(this).val()).draw();
    }
});

// Local events
$dataTables.on('page.dt', function (e, settings, processing) {

    let padding = 15;

    if ($('.fixedHeader-floating').length > 0) {
        padding = padding + 48;
    }

    $('html, body').animate({
        scrollTop: $(this).prev().offset().top - padding
    }, 200);
});

$dataTables.on('draw.dt', function (e, settings) {

    fixBrokenImages();
});

function getPagingType() {

    if (user.userLevel === "0") {
        return 'simple_numbers'
    } else {
        return 'simple_numbers'
    }
}

// Server side
const dtDefaultOptions = {
    "ajax": function (data, callback, settings, $ctx = null) {

        let $this = $(this);
        if ($ctx) {
            $this = $ctx;
        }

        $.ajax({
            url: function () {
                const path = $this.attr('data-path');
                if (!path && user.isLocal) {
                    console.log('Table data-path not set');
                }
                return path;
            }(),
            data: data,
            success: function (data, textStatus, jqXHR) {

                callback(data, textStatus, jqXHR);

                // noinspection JSUnresolvedVariable
                if (data.limited) {
                    const bold = $('li.paginate_button.page-item.next.disabled').length > 0 ? 'font-weight-bold' : '';
                    const donate = $('<li class="donate"><small><a href="/donate"><i class="fas fa-heart text-danger"></i> <span class="' + bold + '">See more!</span></a></small></li>');
                    $this.parent().find('.dt-pagination ul.pagination').append(donate);
                }

            },
            error: function (jqXHR, textStatus, errorThrown) {

                const data = {
                    "draw": "1",
                    "recordsTotal": "0",
                    "recordsFiltered": "0",
                    "data": [],
                    "limited": false
                };

                callback(data, textStatus, null);
            },
            dataType: 'json',
            cache: $this.attr('data-cache') !== "false"
        });
    },
    "processing": false,
    "serverSide": true,
    "pageLength": 100,
    "fixedHeader": true,
    "paging": true,
    "ordering": true,
    "info": false,
    "searching": true,
    "autoWidth": false,
    "lengthChange": false,
    "stateSave": false,
    "orderMulti": false,
    "pagingType": getPagingType(),
    "dom": '<"dt-pagination"p>t<"dt-pagination"p>',
    "language": {
        "processing": '<i class="fas fa-spinner fa-spin fa-3x fa-fw"></i>'
    },
    "drawCallback": function (settings, json) {

        const api = this.api();
        if (api.page.info().pages <= 1) {
            $(this).parent().find('.dt-pagination').hide();
        }

        $(".paginate_button > a").on("focus", function () {
            $(this).blur(); // Fixes scrolling to pagination on every click
        });
    },
    "initComplete": function (settings, json) {

        $dataTables2.on('order.dt', function (e, settings, processing) {

            $('#live-badge').trigger('click');

        });
    }
};

// Server side events
$dataTables2.filter(':not(.table-no-fade)').on('page.dt search.dt', function (e, settings, processing) {

    $(this).fadeTo(500, 0.3);

}).on('draw.dt', function (e, settings, processing) {

    $(this).fadeTo(100, 1);
});

$dataTables2.on('page.dt', function (e, settings, processing) {

    $('html, body').animate({
        scrollTop: $(this).prev().offset().top - 15
    }, 200);
});

$dataTables2.on('draw.dt', function (e, settings, processing) {

    highLightOwnedGames();
    fixBrokenImages();
});

//
function addDataTablesRow(options, data, limit, $table) {

    let $row = $('<tr class="fade-green" />');
    options.createdRow($row[0], data, null);

    if (isIterable(options.columnDefs)) {
        for (const v of options.columnDefs) {

            let value = data[v];

            if ('render' in v) {
                value = v.render(null, null, data);
            }

            const $td = $('<td />').html(value);

            if ('createdCell' in v) {
                v.createdCell($td, null, data, null, null);
            }

            $td.find('[data-livestamp]').html('a few seconds ago');

            $row.append($td);
        }
    }


    $table.prepend($row);

    $table.find('tbody tr').slice(limit).remove();
}

const $priceChart = $('#app-page #prices-chart, #package-page #prices-chart');

if ($priceChart.length > 0 && prices) {

    let chart, request;

    function upateChart(code) {

        // Cancel any current requests
        if (request) {
            request.abort();
        }

        // Update row styles
        $('tr[data-code]').removeClass('font-weight-bold').attr('data-link', '');
        $('tr[data-code=' + code + ']').addClass('font-weight-bold').removeAttr('data-link');

        // Show loading screen
        chart.showLoading();

        request = $.ajax({
            type: "GET",
            data: {
                code: code
            },
            url: $priceChart.attr('data-ajax'),
            dataType: 'json',
            cache: true,
            success: function (data, textStatus, jqXHR) {

                if ('prices' in data) {
                    chart.series[0].setData(data.prices);
                    chart.yAxis[0].update({title: {text: 'Price (' + data.symbol + ')'}});
                    chart.hideLoading();
                }
            },
        });
    }

    $('#prices tr[data-code]').on('click', function (e) {

        if ($(this).hasClass('font-weight-bold')) {
            return
        }

        upateChart($(this).attr('data-code'));

    });

    function loadPriceChart() {

        chart = Highcharts.chart('prices-chart', {
            chart: {
                zoomType: 'x'
            },
            title: {
                text: ''
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                title: {
                    text: 'Date'
                },
                type: 'datetime',
                labels: {
                    step: 1,
                    formatter: function () {
                        return moment(this.value).format("Do MMM YY");
                    },
                },
            },
            yAxis: {
                title: {
                    text: 'Price ($)'
                },
                type: 'linear',
                min: 0,
                allowDecimals: true
            },
            legend: {
                enabled: false
            },
            credits: {
                enabled: false
            },
            series: [
                {
                    type: 'line',
                    name: 'Price',
                    step: 'left',
                    color: '#28a745'
                }
            ],
            annotations: [{
                labelOptions: {
                    backgroundColor: 'rgba(255,255,255,0.5)',
                    verticalAlign: 'top',
                    y: 15
                },
                labels: [{
                    point: {
                        xAxis: 0,
                        yAxis: 0,
                        x: 27.98,
                        y: 255
                    },
                    text: 'Arbois'
                }, {
                    point: {
                        xAxis: 0,
                        yAxis: 0,
                        x: 45.5,
                        y: 611
                    },
                    text: 'Montrond'
                }, {
                    point: {
                        xAxis: 0,
                        yAxis: 0,
                        x: 63,
                        y: 651
                    },
                    text: 'Mont-sur-Monnet'
                }]
            }]
        });

        upateChart(user.userCountry);
    }
}

if ($('#admin-page').length > 0) {

    const $actions = $('#actions a');

    $actions.on('click', function () {
        return confirm('Are you sure?');
    });

    const queuesForm = $('form#queues');
    queuesForm.on("submit", function (e) {
        e.preventDefault();
        $.ajax({
            type: 'post',
            url: queuesForm.attr('action'),
            data: $(this).serialize(),
            success: function (data, textStatus, jqXHR) {
                toast(true, 'Queued');
                queuesForm.trigger("reset");
            },
        });
    });

    websocketListener('admin', function (e) {

        const data = $.parseJSON(e.data);
        toast(true, data.Data.message, '', 0);
    });
}

const $apiPage = $('#api-page');

if ($apiPage.length > 0) {

    $('#sidebar').stickySidebar({
        topSpacing: 0,
        bottomSpacing: 16,
    });

    $('.endpoint').on('mouseenter', function () {
        $(this).select();
    });
}

const $appPage = $('#app-page');

if ($appPage.length > 0) {

    const $modal = $('#news-modal');

    // Detials image click
    const $detailsImage = $('#details img');

    $detailsImage.on('click', function () {
        $('.card-header-tabs a[href="#media"]').tab('show');
    });
    $detailsImage.on("error", function () {
        $(this).attr('src', '/assets/img/no-app-image-banner.jpg');
        $(this).hide();
    });

    // On tab change
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

        const to = $(e.target);
        const from = $(e.relatedTarget);

        // On entering tab
        if (to.attr('href') === '#media') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);
                loadMedia();
            }
        }
        if (to.attr('href') === '#news') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);
                loadNews();
            }
        }
        if (to.attr('href') === '#prices') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);
                loadPriceChart();
            }
        }
        if (to.attr('href') === '#players') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);
                loadAppPlayersChart();
                loadAppPlayerTimes();
            }
        }
        if (to.attr('href') === '#reviews') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);
                loadAppReviewsChart();
            }
        }

        // On leaving tab
        if (from.attr('href') === '#media') {
            resetVideos();
        }

        // On any tab
        $.each(dataTables, function (index, value) {
            // noinspection JSUnresolvedFunction
            value.fixedHeader.adjust();
        });
    });

    function resetVideos() {
        $('video').each(function (index) {
            $(this)[0].pause();
            $(this)[0].currentTime = 0;
        });
    }

    // Websockets
    websocketListener('app', function (e) {

        const data = $.parseJSON(e.data);
        if (data.Data.toString() === $appPage.attr('data-id')) {
            toast(true, 'Click to refresh', 'This app has been updated', -1, 'refresh');
        }
    });

    // Media carousels
    function loadMedia() {

        const $carousel1 = $('#carousel1');
        const $carousel2 = $('#carousel2');

        // noinspection JSUnresolvedFunction
        $carousel1.slick({
            waitForAnimate: false,
            arrows: false,
            autoplay: false,
            dots: false,
            asNavFor: $carousel2,
            adaptiveHeight: true,
            lazyLoad: 'ondemand',
        });

        // noinspection JSUnresolvedFunction
        $carousel2.slick({
            waitForAnimate: false,
            arrows: false,
            slidesToShow: 15,
            autoplay: false,
            dots: false,
            variableWidth: true,
            asNavFor: $carousel1,
            focusOnSelect: true,
            centerMode: true,
            infinite: true,
        });

        $carousel1.on('afterChange', function (event, slick, currentSlide) {

            // Stop all videos
            resetVideos();

            // Auto play current video
            const $video = $carousel1.find('div[data-slick-index=' + currentSlide + '] video');
            if ($video.length > 0) {
                $video[0].play();
            }
        });

        $(document).on('keydown', function (e) {
            if ($('a.active[href="#media"]').length > 0) {
                if (e.keyCode === 37) {
                    // noinspection JSUnresolvedFunction
                    $carousel1.slick('slickPrev');
                }
                if (e.keyCode === 39) {
                    // noinspection JSUnresolvedFunction
                    $carousel1.slick('slickNext');
                }
            }
        });

        // $carousel1.slick('setPosition');
        // $carousel2.slick('setPosition');
    }

    // News data table
    function loadNews() {

        const $newstable = $('#news-table');

        const table = $newstable.DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[2, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-id', data[0]);
            },
            "columnDefs": [
                // Title
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<div><i class="fas fa-newspaper"></i> ' + row[1] + '</div><div class="d-none">' + row[5] + '</div>';
                    },
                    "orderable": false
                },
                // Author
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return row[2];
                    },
                    "orderable": false
                },
                // Date
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return '<span data-toggle="tooltip" data-placement="left" title="' + row[4] + '" data-livestamp="' + row[3] + '"></span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                }
            ]
        }));

        dataTables.push(table);

        $newstable.on('click', 'tr[role=row]', function () {

            const row = table.row($(this));

            // noinspection JSUnresolvedFunction
            if (row.child.isShown()) {

                row.child.hide();
                $(this).removeClass('shown');

            } else {

                row.child($("<div/>").html(row.data()[5]).text()).show();
                $(this).addClass('shown');
            }
        });

        // Fix links
        $('#news a').each(function () {

            const href = $(this).attr('href');
            if (href && !(href.startsWith('http'))) {
                $(this).attr('href', 'http://' + href);
            }
        });
    }

    const defaultAppChartOptions = {
        title: {
            text: ''
        },
        subtitle: {
            text: ''
        },
        credits: {
            enabled: false
        },
        plotOptions: {},
        xAxis: {
            title: {text: ''},
            type: 'datetime'
        },
    };

    function loadAppReviewsChart() {

        $.ajax({
            type: "GET",
            url: '/apps/' + $appPage.attr('data-id') + '/reviews.json',
            dataType: 'json',
            success: function (data, textStatus, jqXHR) {

                if (data === null) {
                    data = [];
                }

                Highcharts.chart('reviews-chart', $.extend(true, {}, defaultAppChartOptions, {
                    chart: {
                        type: 'line'
                    },
                    yAxis: [
                        {
                            allowDecimals: false,
                            title: {text: ''},
                            min: 0,
                            max: 100,
                            endOnTick: false,
                            labels: {
                                formatter: function () {
                                    return this.value + '%';
                                }
                            }
                        },
                        {
                            allowDecimals: false,
                            title: {text: ''},
                            opposite: true,
                            min: 0,
                        }
                    ],
                    legend: {
                        enabled: true
                    },
                    tooltip: {
                        formatter: function () {

                            const time = moment(this.key).format("DD MMM YYYY @ HH:mm");

                            if (this.series.name === 'score') {
                                return this.y.toLocaleString() + '% score on ' + time;
                            } else if (this.series.name === 'positive') {
                                return this.y.toLocaleString() + ' positive reviews on ' + time;
                            } else if (this.series.name === 'negative') {
                                return this.y.toLocaleString() + ' negative reviews on ' + time;
                            }
                        },
                    },
                    series: [
                        {
                            name: 'score',
                            color: '#28a745',
                            data: data['mean_reviews_score'],
                            yAxis: 0,
                            marker: {symbol: 'circle'}
                        },
                        {
                            name: 'positive',
                            color: '#e83e8c',
                            data: data['mean_reviews_positive'],
                            yAxis: 1,
                            marker: {symbol: 'circle'}
                        },
                        {
                            name: 'negative',
                            color: '#007bff',
                            data: data['mean_reviews_negative'],
                            yAxis: 1,
                            marker: {symbol: 'circle'}
                        },
                    ],
                }));

            },
        });
    }

    function loadAppPlayersChart() {

        const defaultAppChartOptions = {
            title: {
                text: ''
            },
            subtitle: {
                text: ''
            },
            credits: {
                enabled: false
            },
            plotOptions: {},
            xAxis: {
                title: {text: ''},
                type: 'datetime'
            },
        };

        $.ajax({
            type: "GET",
            url: '/apps/' + $appPage.attr('data-id') + '/players.json',
            dataType: 'json',
            success: function (data, textStatus, jqXHR) {

                if (data === null) {
                    const now = Date.now();
                    data = {
                        "max_player_count": [[now, 0]],
                        "max_twitch_viewers": [[now, 0]],
                    };
                }

                Highcharts.chart('players-chart', $.extend(true, {}, defaultAppChartOptions, {
                    chart: {
                        type: 'area'
                    },
                    yAxis: [
                        {
                            allowDecimals: false,
                            title: {text: ''},
                            min: 0,
                            labels: {
                                formatter: function () {
                                    return this.value.toLocaleString();
                                },
                            },
                        },
                        {
                            allowDecimals: false,
                            title: {text: ''},
                            min: 0,
                            opposite: true,
                            labels: {
                                formatter: function () {
                                    return this.value.toLocaleString();
                                },
                            },
                        }
                    ],
                    legend: {
                        enabled: false
                    },
                    tooltip: {
                        formatter: function () {
                            if (this.series.name === 'Players') {
                                return this.y.toLocaleString() + ' players on ' + moment(this.key).format("DD MMM YYYY @ HH:mm");
                            } else {
                                return this.y.toLocaleString() + ' Twitch viewers on ' + moment(this.key).format("DD MMM YYYY @ HH:mm");
                            }
                        },
                    },
                    series: [
                        {
                            name: 'Players',
                            color: '#28a745',
                            data: data['max_player_count'],
                            yAxis: 0,
                        },
                        {
                            name: 'Viewers',
                            color: '#6441A4', // Twitch purple
                            data: data['max_twitch_viewers'],
                            yAxis: 1,
                            type: 'line',
                        }
                    ],
                }));

            },
        });
    }

    function loadAppPlayerTimes() {

        const table = $('#top-players-table').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[3, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-id', data[0]);
                $(row).attr('data-link', data[6]);
            },
            "columnDefs": [
                // Rank
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return row[4];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('font-weight-bold')
                    },
                    "orderable": false,
                },
                // Flag
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        if (row[3]) {
                            return '<img data-toggle="tooltip" data-placement="left" title="' + row[7] + '" src="' + row[3] + '" class="rounded" alt="' + row[7] + '">';
                        }
                        return '';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                    },
                    "orderable": false,
                },
                // Player
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return '<img src="' + row[5] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false,
                },
                // Time
                {
                    "targets": 3,
                    "render": function (data, type, row) {
                        return row[2];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false,
                },
            ]
        }));

        dataTables.push(table);
    }
}

if ($('#apps-page').length > 0) {

    $('#user-currency-symbol').append(' ' + user.userCurrencySymbol);

    const $chosens = $('select.form-control-chosen');
    const $table = $('table.table-datatable2');
    const $form = $('form');

    // Set form fields from URL
    if (window.location.search) {
        $form.deserialize(window.location.search.substr(1));
    }

    // Setup drop downs
    $chosens.chosen({
        disable_search_threshold: 10,
        allow_single_deselect: true,
        rtl: false,
        max_selected_options: 10
    });

    // Setup Sliders
    const priceLow = $('#price-low').val();
    const priceHigh = $('#price-high').val();
    const priceElement = $('#price-slider')[0];
    const priceSlider = noUiSlider.create(priceElement, {
        start: [
            parseInt(priceLow ? priceLow : 0),
            parseInt(priceHigh ? priceHigh : 100)
        ],
        connect: true,
        step: 1,
        range: {
            'min': 0,
            'max': 100,
        }
    });

    const scoreLow = $('#score-low').val();
    const scoreHigh = $('#score-high').val();
    const scoreElement = $('#score-slider')[0];
    const scoreSlider = noUiSlider.create(scoreElement, {
        start: [
            parseInt(scoreLow ? scoreLow : 0),
            parseInt(scoreHigh ? scoreHigh : 100)
        ],
        connect: true,
        step: 1,
        range: {
            'min': 0,
            'max': 100
        }
    });

    // Form changes
    $chosens.on('change', redrawTable);
    $form.on('submit', redrawTable);
    priceSlider.on('set', onPriceChange);
    priceSlider.on('update', updateLabels);
    scoreSlider.on('set', onScoreChange);
    scoreSlider.on('update', updateLabels);

    function onPriceChange(e) {
        const prices = priceSlider.get();
        $('#price-low').val(prices[0]);
        $('#price-high').val(prices[1]);
        redrawTable();
    }

    function onScoreChange(e) {
        const scores = scoreSlider.get();
        $('#score-low').val(scores[0]);
        $('#score-high').val(scores[1]);
        redrawTable();
    }

    function redrawTable(e) {

        // Filter out empty form fields
        let formData = $form.serializeArray();
        formData = $.grep(formData, function (v) {
            return v.value !== "";
        });

        $table.DataTable().draw();
        history.pushState({}, document.title, "/apps?" + $.param(formData));
        updateLabels(e);
        return false;
    }

    $(document).ready(updateLabels);

    function updateLabels(e) {

        const prices = priceSlider.get();
        const scores = scoreSlider.get();

        if (prices[0] === prices[1]) {
            $('label#price-label').html('Price (' + user.userCurrencySymbol + Math.round(prices[0]) + ')');
        } else {
            $('label#price-label').html('Price (' + user.userCurrencySymbol + Math.round(prices[0]) + ' - ' + user.userCurrencySymbol + Math.round(prices[1]) + ')');
        }

        if (scores[0] === scores[1]) {
            $('label#score-label').html('Score (' + Math.round(scores[0]) + '%)');
        } else {
            $('label#score-label').html('Score (' + Math.round(scores[0]) + '% - ' + Math.round(scores[1]) + '%)');
        }
    }

    // Setup datatable
    $table.DataTable($.extend(true, {}, dtDefaultOptions, {
        "ajax": function (data, callback, settings) {

            data.search.tags = $('#tags').val();
            data.search.genres = $('#genres').val();
            data.search.developers = $('#developers').val();
            data.search.publishers = $('#publishers').val();
            data.search.platforms = $('#platforms').val();
            data.search.types = $('#types').val();
            data.search.search = $('#search').val();
            data.search.prices = priceSlider.get();
            data.search.scores = scoreSlider.get();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "order": [[2, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[3]);
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
                "orderable": false,
            },
            // Type
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[4];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('d-none d-lg-table-cell');
                },
                "orderable": false,
            },
            // Players
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[7].toLocaleString();
                },
                "orderSequence": ["desc"],
            },
            // Score
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return row[5] + '%';
                },
                "orderSequence": ["desc"],
            },
            // Price
            {
                "targets": 4,
                "render": function (data, type, row) {
                    return row[6];
                },
                "orderSequence": ["desc"],
            },
        ]
    }));
}

const $badgePage = $('#badge-page');

if ($badgePage.length > 0) {

    $('table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "order": [[2, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[5]);
        },
        "columnDefs": [
            // Ranks
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return row[0];
                },
            },
            // Icon / Player
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                }
            },
            // Level
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[3].toLocaleString();
                },
            },
            // Time
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return row[4];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                }
            },
        ]
    }));
}

if ($('#bundles-page').length > 0) {

    const options = $.extend(true, {}, dtDefaultOptions, {
        "order": [[4, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[2]);
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="/assets/img/no-app-image-square.jpg" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                }
            },
            // Discount
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[4] + '%'
                }
            },
            // Apps
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[5].toLocaleString();
                }
            },
            // Packages
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return row[6].toLocaleString();
                }
            },
            // Updated At
            {
                "targets": 4,
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "render": function (data, type, row) {
                    return '<span data-livestamp="' + row[3] + '"></span>';
                }
            }
        ]
    });

    const $table = $('table.table-datatable2');
    const dt = $table.DataTable(options);

    websocketListener('bundles', function (e) {

        const info = dt.page.info();
        if (info.page === 0) { // Page 1

            const data = $.parseJSON(e.data);
            addDataTablesRow(options, data.Data, info.length, $table);
        }
    });
}

if ($('#changes-page').length > 0) {

    const options = $.extend(true, {}, dtDefaultOptions, {
        "order": [[1, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[5]);
        },
        "columnDefs": [
            // Change ID
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return 'Change ' + row[0];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Date
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return '<span data-toggle="tooltip" data-placement="left" title="' + row[2] + '" data-livestamp="' + row[1] + '"></span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Apps
            {
                "targets": 2,
                "render": function (data, type, row) {

                    let apps = [];
                    if (row[3] !== null) {
                        for (let k in row[3]) {
                            if (row[3].hasOwnProperty(k)) {

                                if (row[3][k].name === '') {
                                    row[3][k].name = 'Unknown App';
                                }

                                apps.push('<a href="' + row[3][k].path + '">' + row[3][k].name + '</a>');
                            }
                        }
                    }

                    return apps.join('<br/>');
                },
                "orderable": false
            },
            // Packages
            {
                "targets": 3,
                "render": function (data, type, row) {

                    let packages = [];
                    if (row[4] !== null) {
                        for (let k in row[4]) {
                            if (row[4].hasOwnProperty(k)) {

                                if (row[4][k].name === '') {
                                    row[4][k].name = 'Unknown Package';
                                }

                                packages.push('<a href="' + row[4][k].path + '">' + row[4][k].name + '</a>');
                            }
                        }
                    }

                    return packages.join('<br/>');
                },
                "orderable": false
            }
        ]
    });

    const $table = $('table.table-datatable2');
    const dt = $table.DataTable(options);

    websocketListener('changes', function (e) {

        const info = dt.page.info();
        if (info.page === 0) { // Page 1

            const data = $.parseJSON(e.data);

            // Loop changes in websocket data and add each one
            if (isIterable(data.Data)) {

                data.Data.sort(function (a, b) {
                    return Math.sign(a[0] - b[0]);
                });

                for (const v of data.Data) {
                    addDataTablesRow(options, v, info.length, $table);
                }
            }
        }
    });
}

if ($('#chat-page').length > 0) {

    const channel = $('[data-channel-id]').attr('data-channel-id');

    $.ajax({
        url: '/chat/' + channel + '/chat.json',
        dataType: 'json',
        cache: false,
        success: function (data, textStatus, jqXHR) {

            $('.fa-spin').remove();

            if (isIterable(data)) {
                for (const v of data) {
                    chatRow(v, false);
                }
            }
        },
    });

    websocketListener('chat', function (e) {

        const data = $.parseJSON(e.data);
        chatRow(data.Data);
    });

    function chatRow(data, addToTop = true) {

        const $container = $('ul[data-channel-id=' + data.channel + ']');

        $container.json2html(
            data,
            {
                '<>': 'li', 'class': 'media fade-in', 'style': 'animation-delay: ${i}s', 'html': [
                    {'<>': 'img', 'class': 'mr-3 rounded', 'src': 'https://cdn.discordapp.com/avatars/${author_id}/${author_avatar}.png?size=64', 'alt': '${author_user}'},
                    {
                        '<>': 'div', 'class': 'media-body', 'html': [
                            {
                                '<>': 'h5', 'class': function () {
                                    return 'mt-0 mb-1 rounded' + (addToTop ? ' fade-green' : '');
                                }, 'html': '${content}'
                            },
                            {'<>': 'p', 'class': 'text-muted', 'html': 'By ${author_user} at <span data-livestamp="${timestamp}"></span>'}
                        ]
                    }
                ]
            },
            {
                prepend: addToTop,
            }
        );

        $container.find('li').slice(50).remove();
    }
}

if ($('#commits-page').length > 0) {

    const $table = $('table#commits');

    let page = null;

    $table.on('draw.dt', function () {
        page = null;
    });

    $table.DataTable($.extend(true, {}, dtDefaultOptions, {
        "order": [[1, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[3]);
            $(row).attr('data-target', '_blank');
            if (data[4]) {
                $(row).addClass('table-success', data[0]);
            }
        },
        "columnDefs": [
            // Message
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return row[0];
                },
                "createdCell": function (td, cellData, rowData, row, col) {

                    $(td).attr('id', rowData[5]);
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Time
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return '<span data-toggle="tooltip" data-placement="left" title="' + row[1] + '" data-livestamp="' + row[1] + '">' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Hash
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[5];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Deployed
            {
                "targets": 3,
                "render": function (data, type, row) {

                    if (page === null) {
                        page = $table.DataTable().page.info().page;
                    }

                    if (row[2] || page > 0) {
                        return '<i class="fas fa-check"></i>';
                    } else {
                        return '<i class="fas fa-times"></i>';
                    }
                },
                "orderable": false
            }
        ]
    }));
}

if ($('#contact-page').length > 0) {


}

if ($('#coop-page').length > 0) {

    $('form#add').submit(function (e) {

        e.preventDefault();

        let url = '';

        const val = $('input#id').val();

        if (document.location.href.indexOf("?") >= 0) {
            url = document.location.href + "&p=" + val;
        } else {
            url = document.location.href + "?p=" + val;
        }

        document.location = url;
    });

    $('#addme input').click(function (e) {

        const val = $(this).attr('data-id');

        $('input#id').val(val);
        $('form#add').submit();
    });
}

const $xpPage = $('#experience-page');

if ($xpPage.length > 0) {

    // Scroll to number
    function scroll() {

        if (typeof scrollTo === 'string') {

            const top = $(scrollTo).offset().top - 100;
            $('html, body').animate({scrollTop: top}, 500);

            $('tr').removeClass('table-success');
            $(scrollTo).addClass('table-success');
        }
    }

    $xpPage.on("click", "tr[data-level]", function (e) {

        const level = $(this).attr('data-level');

        if (history.pushState) {
            history.pushState('data', '', '/experience/' + level);
        }

        scrollTo = 'tr[data-level=' + level + ']';
        scroll();
    });

    // Calculator
    function levelToXP(level) {

        let total = 0;

        for (let current = 0; current <= level; current++) {
            total += Math.ceil(current / 10) * 100;
        }

        return total;
    }

    function update() {

        const answer = $('#answer');
        answer.val('Loading..');

        let from = $('#from').val();
        if (from < 1) {
            from = 1;
        }

        let to = $('#to').val();
        if (to < 1) {
            to = 1;
        }

        answer.val((levelToXP(to) - levelToXP(from)).toLocaleString());
    }

    $('#from, #to').change(update);

    $('#calculate').click(function (e) {
        e.preventDefault();
        update();
    });

    $(document).ready(scroll);
    $(document).ready(update);
}

const $groupPage = $('#group-page');

if ($groupPage.length > 0) {

    // Websockets
    websocketListener('group', function (e) {

        const data = $.parseJSON(e.data);
        if (data.Data.toString() === $groupPage.attr('data-id')) {
            toast(true, 'Click to refresh', 'This group has been updated', -1, 'refresh');
        }
    });

    // Load chart
    $.ajax({
        type: "GET",
        url: '/groups/' + $groupPage.attr('data-id') + '/time.json',
        dataType: 'json',
        success: function (data, textStatus, jqXHR) {

            if (data === null) {
                data = [];
            }

            const yAxisGroup = {
                allowDecimals: false,
                title: {
                    text: ''
                },
                labels: {
                    // enabled: false
                },
                // min: 0,
            };

            Highcharts.chart('chart', {

                chart: {
                    type: 'line',
                },
                title: {
                    text: ''
                },
                subtitle: {
                    text: ''
                },
                credits: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                plotOptions: {},
                xAxis: {
                    title: {
                        text: ''
                    },
                    type: 'datetime'

                },
                yAxis: [
                    Object.assign({}, yAxisGroup),
                    Object.assign({}, yAxisGroup),
                    Object.assign({}, yAxisGroup),
                    Object.assign({}, yAxisGroup),
                ],
                tooltip: {
                    formatter: function () {
                        return this.y.toLocaleString() + ' members on ' + moment(this.key).format("dddd DD MMM YYYY @ HH:mm");
                    },
                },
                series: [
                    {
                        name: 'Members',
                        color: '#28a745',
                        data: data['max_members_count'],
                        marker: {symbol: 'circle'},
                        yAxis: 0,
                    },
                    // {
                    //     name: 'In Chat',
                    //     color: '#007bff',
                    //     data: data['max_members_in_chat'],
                    //     marker: {symbol: 'circle'},
                    //     yAxis: 1,
                    // },
                    // {
                    //     name: 'In Game',
                    //     color: '#e83e8c',
                    //     data: data['max_members_in_game'],
                    //     marker: {symbol: 'circle'},
                    //     yAxis: 2,
                    // },
                    // {
                    //     name: 'Online',
                    //     color: '#ffc107',
                    //     data: data['max_members_online'],
                    //     marker: {symbol: 'circle'},
                    //     yAxis: 3,
                    // },
                ],
            });

        },
    });

}
if ($('#groups-trending-page').length > 0) {

    $('form').on('submit', function (e) {

        $table.DataTable().draw();
        return false;
    });

    $('#type, #errors').on('change', function (e) {

        $table.DataTable().draw();
        return false;
    });

    $('table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "ajax": function (data, callback, settings) {

            data.search = {};
            data.search.search = $('#search').val();
            data.search.type = $('#type').val();
            data.search.errors = $('#errors').val();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "order": [[2, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[2]);
            if (data[7] === 'game' && !$('#type').val()) {
                $(row).addClass('table-primary');
            }
            if (data[9]) {
                $(row).addClass('table-danger');
            }
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img data-src="/assets/img/no-app-image-square.jpg" src="' + row[3] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false,
            },
            // Members
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[5].toLocaleString();
                },
                "orderable": false,
            },
            // Trend Value
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[10];
                },
                "orderable": false,
            },
            // Trend Chart
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return '';
                },
                "orderable": false,
            },
            // Link
            {
                "targets": 4,
                "render": function (data, type, row) {
                    return '<a href="' + row[8] + '" target="_blank" rel="nofollow"><i class="fas fa-link" data-target="_blank"></i></a>';
                },
                "orderable": false,
            },
        ]
    }));
}

if ($('#groups-page').length > 0) {

    $('form').on('submit', function (e) {

        $table.DataTable().draw();
        return false;
    });

    $('#type, #errors').on('change', function (e) {

        $table.DataTable().draw();
        return false;
    });

    $('table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "ajax": function (data, callback, settings) {

            data.search = {};
            data.search.search = $('#search').val();
            data.search.type = $('#type').val();
            data.search.errors = $('#errors').val();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "order": [[2, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[2]);
            if (data[7] === 'game' && !$('#type').val()) {
                $(row).addClass('table-primary');
            }
            if (data[9]) {
                $(row).addClass('table-danger');
            }
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img data-src="/assets/img/no-app-image-square.jpg" src="' + row[3] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false,
            },
            // Headline
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[4];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('d-none d-lg-table-cell');
                },
                "orderable": false,
            },
            // Members
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[5].toLocaleString();
                },
                "orderable": false,
            },
            // Link
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return '<a href="' + row[8] + '" target="_blank" rel="nofollow"><i class="fas fa-link" data-target="_blank"></i></a>';
                },
                "orderable": false,
            },
        ]
    }));
}

if ($('#home-page').length > 0) {

    // Players
    $('[data-sort]').on('click', function (e) {

        loadPlayers($(this).attr('data-sort'));
    });

    loadPlayers('level');

    function loadPlayers(sort) {

        $('#players .fa-spin').removeClass('d-none');
        $('#players table').addClass('d-none');

        $('[data-sort]').removeClass('badge-success');
        $('[data-sort="' + sort + '"]').addClass('badge-success');

        $('#column').html(sort);

        $.ajax({
            url: '/home/' + sort + '/players.json',
            dataType: 'json',
            cache: false,
            success: function (data, textStatus, jqXHR) {

                $('#players .fa-spin').addClass('d-none');
                $('#players table').removeClass('d-none');
                $('#players tbody tr').remove();

                if (isIterable(data)) {

                    const $container = $('#players tbody');

                    $container.json2html(
                        data,
                        {
                            '<>': 'tr', 'data-link': '${link}', 'html': [
                                {
                                    '<>': 'td', 'class': 'font-weight-bold', 'html': '${rank}'
                                },
                                {
                                    '<>': 'td', 'class': 'img', 'html': [
                                        {
                                            '<>': 'img', 'src': '${avatar}', 'class': 'rounded'
                                        },
                                        {
                                            '<>': 'span', 'html': '${name}'
                                        },
                                    ]
                                },
                                {
                                    '<>': 'td', 'html': function () {
                                        return this.value.toLocaleString();
                                    }
                                },
                            ]
                        },
                        {
                            prepend: false,
                        }
                    );
                }
            },
        });
    }

    // Prices
    $.ajax({
        url: '/home/prices.json',
        dataType: 'json',
        cache: false,
        success: function (data, textStatus, jqXHR) {
            $('#prices .fa-spin').remove();
            $('#prices table').removeClass('d-none');
            if (isIterable(data)) {
                for (const v of data) {
                    addPriceRow(v, false);
                }
            }
        },
    });

    websocketListener('prices', function (e) {

        const data = $.parseJSON(e.data);
        addPriceRow(data.Data, true);
    });

    function addPriceRow(data, addToTop) {

        const $container = $('#prices tbody');

        $container.json2html(
            data,
            {
                '<>': 'tr', 'data-link': '${link}', 'html': [
                    {
                        '<>': 'td', 'class': 'img', 'html': [
                            {
                                '<>': 'img', 'src': '${avatar}', 'class': 'rounded',
                            },
                            {
                                '<>': 'span', 'html': '${name}', 'class': 'text-truncate',
                            },
                        ]
                    },
                    {
                        '<>': 'td', 'html': '${before}', 'nowrap': 'nowrap'
                    },
                    {
                        '<>': 'td', 'html': '${after}', 'nowrap': 'nowrap'
                    },
                    {
                        '<>': 'td', 'nowrap': 'nowrap', 'html': [
                            {
                                '<>': 'span', 'data-toggle': 'tooltip', 'data-placement': 'left', 'data-livestamp': '${time}',
                            }
                        ],
                    },
                ]
            },
            {
                prepend: addToTop,
            }
        );

        $container.find('tr').slice(15).remove();
    }
}

if ($('#login-page').length > 0) {

}

if ($('#new-releases-page').length > 0) {

    $('table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "order": [[3, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[3]);
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
            },
            // Price
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[5];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderSequence": ["desc", "asc"],
            },
            // Score
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[7] + '%';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderSequence": ["desc", "asc"],
            },
            // Players
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return row[8].toLocaleString();
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderSequence": ["desc", "asc"],
            },
            // Release Date
            {
                "targets": 4,
                "render": function (data, type, row) {
                    return row[6];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderSequence": ["desc", "asc"],
            },
            // Chart
            {
                "targets": 5,
                "render": function (data, type, row) {
                    return '<div data-app-id="' + row[0] + '"><i class="fas fa-spinner fa-spin"></i></div>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('chart');
                },
                "orderSequence": ["desc", "asc"],
            },
        ]
    }));
}

if ($('#news-page').length > 0) {

    const $table = $('table.table-datatable2');

    // On tab change
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

        const to = $(e.target);
        const from = $(e.relatedTarget);

        // On entering tab
        if (to.attr('href') === '#apps') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadNewsAjax();
            }
        }

        // On any tab
        $.each(dataTables, function (index, value) {
            value.fixedHeader.adjust();
        });
    });

    // Show more article
    $('.minned').on('click', function (e) {
        $(this).toggleClass('minned');
    });

    function loadNewsAjax() {

        const table = $table.DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[2, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-app-id', data[6]);
            },
            "columnDefs": [
                // Game
                {
                    "targets": 0,
                    "render": function (data, type, row) {

                        // Icon URL
                        if (row[8] === '') {
                            row[8] = '/assets/img/no-app-image-square.jpg';
                        } else if (!row[8].startsWith("/") && !row[8].startsWith("http")) {
                            row[8] = 'https://steamcdn-a.akamaihd.net/steamcommunity/public/images/apps/' + row[6] + '/' + row[8] + '.jpg';
                        }

                        return '<img src="' + row[8] + '" class="rounded square" alt="' + row[7] + '"><span>' + row[7] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                        $(td).attr('data-link', rowData[9]);
                    },
                    "orderable": false
                },
                // Title
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return '<span>' + row[1] + '</span><div class="d-none">' + row[5] + '</div>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('article-title');
                    },
                    "orderable": false
                },
                // Date
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return '<span data-toggle="tooltip" data-placement="left" title="' + row[4] + '" data-livestamp="' + row[3] + '"></span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                }
            ]
        }));

        dataTables.push(table);

        $table.on('click', 'tr[role=row] td.article-title', function () {

            const $tr = $(this).closest('tr');
            const row = table.row($tr);

            if (row.child.isShown()) {

                row.child.hide();
                $tr.removeClass('shown');

            } else {

                row.child($("<div/>").html(row.data()[5]).text()).show();
                $tr.addClass('shown');
            }
        });
    }
}

const $packagePage = $('#package-page');

if ($packagePage.length > 0) {

    // On tab change
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

        const to = $(e.target);
        const from = $(e.relatedTarget);

        // On entering tab
        if (to.attr('href') === '#prices') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);
                loadPriceChart();
            }
        }

        // On any tab
        $.each(dataTables, function (index, value) {
            value.fixedHeader.adjust();
        });
    });

    // Websockets
    websocketListener('package', function (e) {

        const data = $.parseJSON(e.data);
        if (data.Data.toString() === $packagePage.attr('data-id')) {
            toast(true, 'Click to refresh', 'This package has been updated', -1, 'refresh');
        }
    });
}

if ($('#packages-page').length > 0) {

    const options = $.extend(true, {}, dtDefaultOptions, {
        "order": [[4, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[1]);
        },
        "columnDefs": [
            // Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[8] + '" class="rounded square" alt="' + row[2] + '"><span>' + row[2] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
            },
            // Coming Soon
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[3];
                },
                "orderable": false
            },
            // Apps
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[4].toLocaleString();
                }
            },
            // Price
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return row[5];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                }
            },
            // Updated Time
            {
                "targets": 4,
                "render": function (data, type, row) {
                    return '<span data-toggle="tooltip" data-placement="left" title="' + row[7] + '" data-livestamp="' + row[6] + '">' + row[7] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                }
            }
        ]
    });

    const $table = $('table.table-datatable2');
    const dt = $table.DataTable(options);

    websocketListener('packages', function (e) {

        const info = dt.page.info();
        if (info.page === 0) { // Page 1

            const data = $.parseJSON(e.data);
            addDataTablesRow(options, data.Data, info.length, $table);
        }
    });
}

if ($('#queues-page').length > 0 || $('#player-missing-page').length > 0) {

    const $playerPage = $('#player-missing-page');

    websocketListener('profile', function (e) {

        const data = $.parseJSON(e.data);
        if (data.Data.toString() === $playerPage.attr('data-id')) {

            toast(true, '', 'Player found!');

            location.reload();

        }
    });
}

const $playerPage = $('#player-page');

if ($playerPage.length > 0) {

    // Update link
    $('a[data-update-id]').on('click', function (e) {

        e.preventDefault();

        const $link = $(this);

        $('i', $link).addClass('fa-spin');

        $.ajax({
            url: '/players/' + $(this).attr('data-update-id') + '/update.json',
            dataType: 'json',
            cache: false,
            success: function (data, textStatus, jqXHR) {

                toast(data.success, data.toast);

                $('i', $link).removeClass('fa-spin');

                if (data.log) {
                    console.log(data.log);
                }
            },
        });
    });

    // On tab change
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

        const to = $(e.target);
        const from = $(e.relatedTarget);

        // On entering tab
        if (to.attr('href') === '#charts') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadPlayerCharts();
            }
        }
        if (to.attr('href') === '#games') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadPlayerGames();
            }
        }
        if (to.attr('href') === '#badges') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadPlayerBadges();
            }
        }
        if (to.attr('href') === '#friends') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadPlayerFriends();
            }
        }

        // On any tab
        $.each(dataTables, function (index, value) {
            value.fixedHeader.adjust();
        });
    });

    // Websockets
    websocketListener('profile', function (e) {

        const data = $.parseJSON(e.data);
        if (data.Data.toString() === $playerPage.attr('data-id')) {
            toast(true, 'Click to refresh', 'This player has been updated', -1, 'refresh');
        }

    });

    function loadPlayerGames() {

        const dt = $('#games #all-games').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[2, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-app-id', data[0]);
                $(row).attr('data-link', data[7]);
            },
            "columnDefs": [
                // Icon / Name
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                    }
                },
                // Price
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return row[5];
                    },
                },
                // Time
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return row[4];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    }
                },
                // Price/Time
                {
                    "targets": 3,
                    "render": function (data, type, row) {
                        return row[6];
                    },
                }
            ]
        }));

        dataTables.push(dt);

        const dt2 = $('#games #recent-games').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[2, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-app-id', data[0]);
                $(row).attr('data-link', data[5]);
            },
            "columnDefs": [
                // Icon / Name
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<img src="' + row[1] + '" class="rounded square" alt="' + row[2] + '"><span>' + row[2] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                    }
                },
                // Price
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return row[3].toLocaleString();
                    },
                },
                // Time
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return row[4].toLocaleString();
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    }
                },
            ]
        }));

        dataTables.push(dt2);
    }

    function loadPlayerFriends() {

        const dt = $('#friends table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[2, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-link', data[1]);
            },
            "columnDefs": [
                // Icon / Friend
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<img src="' + row[2] + '" class="rounded square" data-src="/assets/img/no-player-image.jpg" alt="' + row[3] + '"><span>' + row[3] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                    },
                    "orderable": false,
                },
                // Level
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return row[4].toLocaleString();
                    },
                    'orderSequence': ['desc', 'asc'],
                },
                // Games
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        if (!row[5]) {
                            return '-';
                        } else if (row[6] === 0) {
                            return $lockIcon;
                        } else {
                            return row[6].toLocaleString();
                        }
                    },
                    'orderSequence': ['desc', 'asc'],
                },
                // Logged Off
                {
                    "targets": 3,
                    "render": function (data, type, row) {
                        return row[7];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    'orderSequence': ['desc', 'asc'],
                },
                // Friend Since
                {
                    "targets": 4,
                    "render": function (data, type, row) {
                        return row[8];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    'orderSequence': ['asc', 'desc'],
                },
            ]
        }));

        dataTables.push(dt);
    }

    function loadPlayerBadges() {

        const dt = $('#badges table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[2, 'desc']],
            "createdRow": function (row, data, dataIndex) {
                $(row).attr('data-app-id', data[0]);
                $(row).attr('data-link', data[2]);
            },
            "columnDefs": [
                // Icon / App Name
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<img src="' + row[5] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).addClass('img');
                        $(td).attr('nowrap', 'nowrap');
                    },
                },
                // Level / XP
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return row[6].toLocaleString() + ' (' + row[8].toLocaleString() + 'xp)';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    }
                },
                // Scarcity
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return row[7].toLocaleString();
                    },
                },
                // Completion Time
                {
                    "targets": 3,
                    "render": function (data, type, row) {
                        return row[3].toLocaleString();
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    }
                },
            ]
        }));

        dataTables.push(dt);
    }

    function loadPlayerCharts() {

        const defaultPlayerChartOptions = {
            chart: {
                type: 'line',
            },
            title: {
                text: ''
            },
            subtitle: {
                text: ''
            },
            credits: {
                enabled: false
            },
            legend: {
                enabled: true
            },
            plotOptions: {},
            xAxis: {
                title: {
                    text: ''
                },
                type: 'datetime'
            },
        };

        $.ajax({
            type: "GET",
            url: '/players/' + $playerPage.attr('data-id') + '/history.json',
            dataType: 'json',
            success: function (data, textStatus, jqXHR) {

                if (data === null) {
                    data = [];
                }

                const yAxisHistory = {
                    allowDecimals: false,
                    title: {
                        text: ''
                    },
                    labels: {
                        enabled: false
                    },
                };

                Highcharts.chart('history-chart', $.extend(true, {}, defaultPlayerChartOptions, {

                    yAxis: [
                        yAxisHistory,
                        yAxisHistory,
                        yAxisHistory,
                        yAxisHistory,
                        yAxisHistory,
                    ],
                    tooltip: {
                        formatter: function () {
                            return this.y.toLocaleString() + ' ' + this.series.name.toLowerCase() + ' on ' + moment(this.key).format("dddd DD MMM YYYY");
                        },
                    },
                    series: [
                        {
                            name: 'Level',
                            color: '#28a745',
                            data: data['mean_level'],
                            marker: {symbol: 'circle'},
                            yAxis: 0,
                        },
                        {
                            name: 'Games',
                            color: '#007bff',
                            data: data['mean_games'],
                            marker: {symbol: 'circle'},
                            yAxis: 1,
                        },
                        {
                            name: 'Badges',
                            color: '#e83e8c',
                            data: data['mean_badges'],
                            marker: {symbol: 'circle'},
                            yAxis: 2,
                        },
                        {
                            name: 'Playtime',
                            color: '#ffc107',
                            data: data['mean_playtime'],
                            marker: {symbol: 'circle'},
                            yAxis: 3,
                        },
                        {
                            name: 'Friends',
                            color: '#343a40',
                            data: data['mean_friends'],
                            marker: {symbol: 'circle'},
                            yAxis: 4,
                        },
                    ],
                }));

                const yAxisRanks = {
                    allowDecimals: false,
                    title: {
                        text: ''
                    },
                    reversed: true,
                    min: 1,
                    labels: {
                        enabled: false
                    },
                };

                Highcharts.chart('ranks-chart', $.extend(true, {}, defaultPlayerChartOptions, {
                    yAxis: [
                        yAxisRanks,
                        yAxisRanks,
                        yAxisRanks,
                        yAxisRanks,
                        yAxisRanks,
                    ],
                    tooltip: {
                        formatter: function () {
                            return this.series.name + ' rank ' + this.y.toLocaleString() + ' on ' + moment(this.key).format("dddd DD MMM YYYY");
                        },
                    },
                    series: [
                        {
                            name: 'Level',
                            color: '#28a745',
                            data: data['mean_level_rank'],
                            marker: {symbol: 'circle'},
                            yAxis: 0,
                        },
                        {
                            name: 'Games',
                            color: '#007bff',
                            data: data['mean_games_rank'],
                            marker: {symbol: 'circle'},
                            yAxis: 1,
                        },
                        {
                            name: 'Badges',
                            color: '#e83e8c',
                            data: data['mean_badges_rank'],
                            marker: {symbol: 'circle'},
                            yAxis: 2,
                        },
                        {
                            name: 'Playtime',
                            color: '#ffc107',
                            data: data['mean_playtime_rank'],
                            marker: {symbol: 'circle'},
                            yAxis: 3,
                        },
                        {
                            name: 'Friends',
                            color: '#343a40',
                            data: data['mean_friends_rank'],
                            marker: {symbol: 'circle'},
                            yAxis: 4,
                        }
                    ],
                }));

            },
        });

    }
}

if ($('#ranks-page').length > 0) {

    $('form').on('submit', function (e) {

        $table.DataTable().draw();
        return false;
    });

    $('table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "ajax": function (data, callback, settings) {

            data.search = {};
            data.search.search = $('#search').val();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "language": {
            "zeroRecords": "No players found <a href='/players/add'>Add a Player</a>",
        },
        "order": [[3, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', '/players/' + data[1]);
        },
        "columnDefs": [
            // Rank
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return row[0];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('font-weight-bold')
                },
                "orderable": false
            },
            // Player
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return '<img src="' + row[3] + '" class="rounded square" alt="' + row[2] + '"><span>' + row[2] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img')
                },
                "orderable": false
            },
            // Flag
            {
                "targets": 2,
                "render": function (data, type, row) {
                    if (row[11]) {
                        return '<img data-toggle="tooltip" data-placement="left" title="' + row[12] + '" src="' + row[11] + '" class="rounded" alt="' + row[12] + '">';
                    }
                    return '';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
                "orderable": false
            },
            // Avatar 2 / Level
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return '<div class="' + row[4] + ' square"></div><span>' + row[5].toLocaleString() + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img')
                },
                "orderSequence": ["desc"],
            },
            // Games
            {
                "targets": 4,
                "render": function (data, type, row) {

                    if (row[6]) {
                        return row[6].toLocaleString();
                    }
                    return $lockIcon;
                },
                "orderSequence": ["desc"],
            },
            // Badges
            {
                "targets": 5,
                "render": function (data, type, row) {
                    return row[7].toLocaleString();
                },
                "orderSequence": ["desc"],
            },
            // Time
            {
                "targets": 6,
                "render": function (data, type, row) {

                    if (row[8] === '-') {
                        return $lockIcon;
                    }

                    return row[8];
                },
                "createdCell": function (td, cellData, rowData, row, col) {

                    $(td).attr('nowrap', 'nowrap');

                    if (rowData[8] !== '0m') {
                        $(td).attr('data-toggle', 'tooltip').attr('data-placement', 'left').attr('title', rowData[9]);
                    }
                },
                "orderSequence": ["desc"],
            },
            // Friends
            {
                "targets": 7,
                "render": function (data, type, row) {

                    if (row[10] === 0) {
                        return $lockIcon;
                    }

                    return row[10].toLocaleString();
                },
                "orderSequence": ["desc"],
            }
        ]
    }));
}
if ($('#price-changes-page').length > 0) {

    const $chosens = $('select.form-control-chosen');
    const $table = $('table.table-datatable2');
    const $form = $('form');

    // Set form fields from URL
    if (window.location.search) {
        $form.deserialize(window.location.search.substr(1));
    }

    // Setup drop downs
    $chosens.chosen({
        disable_search_threshold: 10,
        allow_single_deselect: true,
        rtl: false,
        max_selected_options: 10
    });

    // Setup Sliders
    const changeLow = $('#change-low').val();
    const changeHigh = $('#change-high').val();
    const changeElement = $('#change-slider')[0];
    const changeSlider = noUiSlider.create(changeElement, {
        start: [
            parseInt(changeLow ? changeLow : -100),
            parseInt(changeHigh ? changeHigh : 100)
        ],
        connect: true,
        step: 1,
        range: {
            'min': -100,
            'max': 100
        }
    });

    const priceLow = $('#price-low').val();
    const priceHigh = $('#price-high').val();
    const priceElement = $('#price-slider')[0];
    const priceSlider = noUiSlider.create(priceElement, {
        start: [
            parseInt(priceLow ? priceLow : -100),
            parseInt(priceHigh ? priceHigh : 100)
        ],
        connect: true,
        step: 1,
        range: {
            'min': 0,
            'max': 100
        }
    });

    $chosens.on('change', redrawTable);
    $form.on('submit', redrawTable);
    changeSlider.on('set', onPercentChange);
    changeSlider.on('update', updateLabels);
    priceSlider.on('set', onPriceChange);
    priceSlider.on('update', updateLabels);

    function onPercentChange(e) {

        const percents = changeSlider.get();
        $('#change-low').val(percents[0]);
        $('#change-high').val(percents[1]);
        redrawTable();
    }

    function onPriceChange(e) {

        const prices = priceSlider.get();
        $('#price-low').val(prices[0]);
        $('#price-high').val(prices[1]);
        redrawTable();
    }

    function redrawTable(e) {

        // Filter out empty form fields
        let formData = $form.serializeArray();
        formData = $.grep(formData, function (v) {
            return v.value !== "";
        });

        $table.DataTable().draw();
        history.pushState({}, document.title, '/price-changes?' + $.param(formData));
        updateLabels(e);
        return false;
    }

    $(document).ready(updateLabels);

    function updateLabels(e) {

        const percents = changeSlider.get();
        const prices = priceSlider.get();

        if (percents[0] === percents[1]) {
            $('label#change-label').html('Price Change Percent (' + Math.round(percents[0]) + '%)');
        } else {
            $('label#change-label').html('Price Change Percent (' + Math.round(percents[0]) + '% - ' + Math.round(percents[1]) + '%)');
        }

        if (prices[0] === prices[1]) {
            $('label#price-label').html('Final Price (' + user.userCurrencySymbol + Math.round(prices[0]) + ')');
        } else {
            $('label#price-label').html('Final Price (' + user.userCurrencySymbol + Math.round(prices[0]) + ' - ' + user.userCurrencySymbol + Math.round(prices[1]) + ')');
        }
    }

    // Init table
    const options = $.extend(true, {}, dtDefaultOptions, {
        "order": [[4, 'desc']],
        "ajax": function (data, callback, settings) {

            data.search.type = $('#type').val();
            data.search.percents = changeSlider.get();
            data.search.prices = priceSlider.get();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[5]);

            let x;
            if (data[9]) {
                x = Math.min(data[9], 100); // Get a range of -100 to 100
                x += 100; // Get a range of 0 to 200
                x = x / 2; // Get a range of 0 to 100
            } else {
                x = 100; // Infinite price increase
            }

            $(row).addClass('col-grad-' + Math.round(x));
        },
        "columnDefs": [
            // App/Package Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[4] + '" class="rounded square" alt="' + row[3] + '"><span>' + row[3] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img')
                },
                "orderable": false
            },
            // Before
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[6];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // After
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[7];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Change
            {
                "targets": 3,
                "render": function (data, type, row) {

                    const small = '<small>' + row[9] + '%</small>';

                    if (row[9] === 0) {
                        return row[8];
                    }

                    return row[8] + ' ' + small;
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            },
            // Time
            {
                "targets": 4,
                "render": function (data, type, row) {
                    return '<span data-toggle="tooltip" data-placement="left" title="' + row[10] + '" data-livestamp="' + row[11] + '">' + row[10] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false
            }
        ]
    });

    // Update table live
    const dt = $table.DataTable(options);

    websocketListener('prices', function (e) {

        const info = dt.page.info();
        if (info.page === 0) { // Page 1

            const data = $.parseJSON(e.data);
            addDataTablesRow(options, data.Data, info.length, $table);
        }
    });
}

if ($('#product-keys-page').length > 0) {

    const $table = $('table.table-datatable2');

    // Setup datatable
    $table.DataTable($.extend(true, {}, dtDefaultOptions, {
        "ajax": function (data, callback, settings) {

            data.search.key = $('#key').val();
            data.search.value = $('#value').val();
            data.search.type = $("input[name=type]:checked").val();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "order": [[0, 'asc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[3]);
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
            },
            // Value
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[4];
                },
                "orderable": false
            },
        ]
    }));
}

if ($('#queues-page').length > 0 || $('#player-missing-page').length > 0) {

    let activeWindow = true;

    $(window).on('focus', function () {
        activeWindow = true;
    });

    $(window).on('blur', function () {
        activeWindow = false;
    });

    const charts = {};
    $('[data-queue]').each(function (index, value) {
        charts[$(this).attr('data-queue')] = loadChart($(this).find('div').attr('id'));
    });

    updateCharts();

    const timer = window.setInterval(updateCharts, 10000); // 10 Seconds

    function updateCharts() {

        if (!activeWindow) {
            return;
        }

        $.ajax({
            url: '/queues/queues.json',
            dataType: 'json',
            cache: false,
            success: function (data, textStatus, jqXHR) {

                $.each(charts, function (index, value) {
                    value.series[0].setData(data[index]['sum_messages']);
                });

            },
            error: function (xhr, ajaxOptions, thrownError) {
                clearTimeout(timer);
                $('#live-badge').addClass('badge-danger').removeClass('badge-secondary badge-success');
                toast(false, 'Live functionality has stopped');
            }
        });
    }

    function loadChart(id) {

        return Highcharts.chart(id, {
            chart: {
                animation: false
            },
            title: {
                text: ''
            },
            subtitle: {
                text: ''
            },
            credits: {
                enabled: false
            },
            legend: {
                enabled: false
            },
            xAxis: {
                title: {
                    text: ''
                },
                labels: {
                    step: 1,
                    formatter: function () {
                        return moment(this.value).format("h:mm");
                    },
                },
                type: 'datetime',
            },
            yAxis: [
                {
                    title: {
                        text: ''
                    },
                    allowDecimals: false,
                    min: 0,
                }
            ],
            plotOptions: {
                series: {
                    marker: {
                        enabled: false // Too close together
                    },
                    animation: false
                }
            },
            series: [
                {
                    color: '#28a745',
                    yAxis: 0,
                    name: 'size',
                    type: 'areaspline',
                },
            ],
            tooltip: {
                formatter: function () {
                    return this.y.toLocaleString() + ' items in the queue at ' + moment(this.key).format("h:mm") + ' UTC';
                },
            }
        });
    }
}

function recaptchaCallback(code) {

    $('form[data-recaptcha] button[type=submit]').prop("disabled", false);


    const inputs = $('form[data-recaptcha] input[type=text], form input[type=email], form textarea').filter(function () {
        return $(this).val() === '';
    });

    if (inputs.length > 0) {
        inputs.get(0).focus();
    } else {
        // $('form[data-recaptcha]').submit();
    }
}

if ($('#settings-page').length > 0) {

    // Password
    $('input:password').pwstrength({
        ui: {
            showPopover: false,
            showErrors: false,
        },
        common: {
            usernameField: '#email'
        }
    });

    // Browser alert permissions
    // const $checkbox = $('#browser-alerts');
    //
    // $checkbox.on('click', function () {
    //     if ($(this).is(':checked')) {
    //
    //         Push.Permission.request(
    //             function () {
    //             },
    //             function () {
    //                 alert('You have denied notification access in your browser.');
    //                 $(this).prop("checked", false);
    //             }
    //         );
    //     }
    // });

    // On tab change
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

        const to = $(e.target);
        const from = $(e.relatedTarget);

        // On entering tab
        if (to.attr('href') === '#events') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadEvents();
            }
        }
        if (to.attr('href') === '#donations') {
            if (!to.attr('loaded')) {
                to.attr('loaded', 1);

                loadDonations();
            }
        }

        // On any tab
        $.each(dataTables, function (index, value) {
            value.fixedHeader.adjust();
        });
    });

    function loadEvents() {

        const table = $('#events table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[0, 'desc']],
            "columnDefs": [
                // Time
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<span data-toggle="tooltip" data-placement="left" title="' + row[1] + '" data-livestamp="' + row[0] + '">' + row[1] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                },
                // Type
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return '<i class="fas ' + row[7] + '"></i> ' + row[2];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                },
                // IP
                {
                    "targets": 2,
                    "render": function (data, type, row) {

                        if (row[3] === row[6]) {
                            return '<span class="font-weight-bold" data-toggle="tooltip" data-placement="left" title="Your current IP">' + row[3] + '</span>';
                        }
                        return row[3];
                    },
                    "orderable": false
                },
                // User Agent
                {
                    "targets": 3,
                    "render": function (data, type, row) {
                        // return row[4];
                        return '<span data-toggle="tooltip" data-placement="left" title="' + row[4] + '">' + row[5] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                }
            ]
        }));

        dataTables.push(table);
    }

    function loadDonations() {

        const table = $('#donations table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
            "order": [[0, 'desc']],
            "columnDefs": [
                // Time
                {
                    "targets": 0,
                    "render": function (data, type, row) {
                        return '<span data-toggle="tooltip" data-placement="left" title="' + row[1] + '" data-livestamp="' + row[0] + '">' + row[1] + '</span>';
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                },
                // Type
                {
                    "targets": 1,
                    "render": function (data, type, row) {
                        return '<i class="fas ' + row[7] + '"></i> ' + row[2];
                    },
                    "createdCell": function (td, cellData, rowData, row, col) {
                        $(td).attr('nowrap', 'nowrap');
                    },
                    "orderable": false
                },
            ]
        }));

        dataTables.push(table);
    }
}

if ($('#stats-page').length > 0) {

    const defaultStatsChartOptions = {
        chart: {
            type: 'column'
        },
        title: {
            text: ''
        },
        subtitle: {
            text: ''
        },
        credits: {
            enabled: false
        },
        legend: {
            enabled: false
        },
        xAxis: {
            title: {
                text: ''
            },
            type: 'category'
        },
        yAxis: {
            allowDecimals: false,
            title: {
                text: ''
            }
        },
        series: [{
            color: '#28a745',
        }],
        plotOptions: {
            series: {
                pointPadding: 0,
                groupPadding: 0,
            }
        }
    };

    $.ajax({
        type: "GET",
        url: '/stats/client-players.json',
        dataType: 'json',
        success: function (data, textStatus, jqXHR) {

            if (data === null) {
                data = [];
            }

            Highcharts.chart('client-players', $.extend(true, {}, defaultStatsChartOptions, {
                chart: {
                    type: 'area',
                },
                xAxis: {
                    type: 'datetime',
                    // tickInterval: 5,
                },
                tooltip: {
                    formatter: function () {

                        const time = moment(this.key).format("dddd DD MMM YYYY @ HH:mm");

                        if (this.series.name === 'ingame') {
                            return this.y.toLocaleString() + ' people in a game on ' + time;
                        } else {
                            return this.y.toLocaleString() + ' people online on ' + time;
                        }
                    },
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    window.location.href = '/apps?score-low=' + this.x + '&score-high=' + (this.x + 1);
                                }
                            }
                        }
                    }
                },
                series: [
                    {
                        name: 'ingame',
                        marker: {symbol: 'circle'},
                        data: data['max_player_count'],
                    },
                    {
                        name: 'online',
                        marker: {symbol: 'circle'},
                        color: '#007bff',
                        data: data['max_player_online'],
                        type: 'line',
                    },
                ]
            }));
        },
    });

    $.ajax({
        type: "GET",
        url: '/stats/app-scores.json',
        dataType: 'json',
        success: function (data, textStatus, jqXHR) {

            if (data === null) {
                data = [];
            }

            Highcharts.chart('scores', $.extend(true, {}, defaultStatsChartOptions, {
                xAxis: {
                    tickInterval: 5,
                },
                tooltip: {
                    formatter: function () {
                        return this.y.toLocaleString() + ' apps have ' + this.x + '/100';
                    },
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    window.location.href = '/apps?score-low=' + this.x + '&score-high=' + (this.x + 1);
                                }
                            }
                        }
                    }
                },
                series: [{
                    data: data
                }]
            }));
        },
    });

    $.ajax({
        type: "GET",
        url: '/stats/app-types.json',
        dataType: 'json',
        success: function (data, textStatus, jqXHR) {

            if (data === null) {
                data = [];
            }

            Highcharts.chart('types', $.extend(true, {}, defaultStatsChartOptions, {
                xAxis: {
                    labels: {
                        rotation: -20,
                    }
                },
                tooltip: {
                    formatter: function () {
                        return this.y.toLocaleString() + ' ' + this.key + ' apps';
                    },
                },
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    let name = this.name.toLowerCase();
                                    if (name === 'unknown') {
                                        name = '';
                                    }
                                    window.location.href = '/apps?types=' + name;
                                }
                            }
                        }
                    }
                },
                series: [{
                    data: data,
                    dataLabels: {
                        enabled: true,
                        formatter: function () {
                            return this.y.toLocaleString();
                        }
                    }
                }]
            }));
        },
    });

    $.ajax({
        type: "GET",
        url: '/stats/release-dates.json',
        dataType: 'json',
        success: function (data, textStatus, jqXHR) {

            if (data === null) {
                data = [];
            }

            Highcharts.chart('release-dates', $.extend(true, {}, defaultStatsChartOptions, {
                chart: {
                    type: 'area',
                },
                xAxis: {
                    type: 'datetime'
                },
                tooltip: {
                    formatter: function () {
                        return this.y.toLocaleString() + ' apps released on ' + moment(this.key).format("dddd DD MMM YYYY");
                    },
                },
                series: [{
                    data: data
                }],
                plotOptions: {
                    area: {
                        lineWidth: 1,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                    }
                },
            }));
        },
    });
}

const $steamApiPage = $('#steam-api-page');

if ($steamApiPage.length > 0) {

    $('#sidebar').stickySidebar({
        topSpacing: 0,
        bottomSpacing: 16,
    });

    $('.endpoint').on('mouseenter', function () {
        $(this).select();
    });

    const $form = $steamApiPage.find('form#key-form');

    $form.on('submit', function (e) {

        e.preventDefault();
        localStorage.setItem('settings', $form.serialize());
        setMethodSettings();
        toast(true, 'Settings Saved');
    });

    function setMethodSettings() {

        const key = $('#key-form input[name=key]').val();
        const format = $('#key-form select[name=format]').val();

        // if (key) {
        //     $steamApiPage.find('table').show();
        // } else {
        //     $steamApiPage.find('table').hide();
        // }

        $('div.interface input[name=key]').val(key);
        $('div.interface input[name=format]').val(format);
    }

    $form.deserialize(localStorage.getItem('settings'));
    setMethodSettings();
}

const $trendingPage = $('#trending-apps-page');
const $table = $('table.table-datatable2');

if ($trendingPage.length > 0) {

    $table.DataTable($.extend(true, {}, dtDefaultOptions, {
        "order": [[3, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[3]);
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
                "orderable": false,
            },
            // Price
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[4];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false,
            },
            // Players
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[6].toLocaleString();
                },
                "orderSequence": ["desc", "asc"],
            },
            // Trend Value
            {
                "targets": 3,
                "render": function (data, type, row) {
                    return row[5].toLocaleString();
                },
                "orderSequence": ["desc", "asc"],
            },
            // Chart
            {
                "targets": 4,
                "render": function (data, type, row) {
                    return '<div data-app-id="' + row[0] + '"><i class="fas fa-spinner fa-spin"></i></div>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('chart');
                },
                "orderable": false,
            },
        ]
    }));
}

if ($trendingPage.length > 0 || $('#new-releases-page').length > 0) {

    $table.on('draw.dt', function (e, settings, processing) {
        loadCharts();
    });

    function loadCharts() {

        const vals = $('td.chart div[data-app-id]')
            .map(function () {
                return $(this).attr('data-app-id');
            })
            .get()
            .join(',');

        $.ajax({
            type: "GET",
            url: '/apps/trending/charts.json?ids=' + vals,
            dataType: 'json',
            success: function (datas, textStatus, jqXHR) {

                if (datas === null) {
                    return
                }

                $('div[data-app-id]').each(function (index) {

                    let data = {};
                    const appID = $(this).attr('data-app-id');

                    if (datas !== null && appID in datas && 'max_player_count' in datas[appID]) {
                        data = datas[appID]['max_player_count'];
                    } else {
                        data = [];
                    }

                    Highcharts.chart(this, {
                        chart: {
                            type: 'area',
                            margin: [0, 0, 0, 0],
                            skipClone: true,
                            backgroundColor: null,
                            height: 32,
                        },
                        title: {
                            text: ''
                        },
                        subtitle: {
                            text: ''
                        },
                        credits: {
                            enabled: false
                        },
                        legend: {
                            enabled: false
                        },
                        xAxis: {
                            title: {text: null},
                            labels: {enabled: false},
                            type: 'datetime',
                        },
                        yAxis: {
                            title: {text: null},
                            labels: {enabled: false},
                            min: 0,
                        },
                        plotOptions: {
                            series: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },
                        tooltip: {
                            hideDelay: 0,
                            outside: true,
                            shared: true,
                            formatter: function () {
                                return this.y.toLocaleString() + ' players on ' + moment(this.x).format("DD MMM YYYY @ HH:mm");
                            },
                            style: {
                                'width': '500px',
                            }
                        },
                        series: [
                            {
                                color: '#28a745',
                                data: data,
                            },
                        ],
                    });
                });
            },
        });
    }
}

//# sourceMappingURL=typescript.js.map
if ($('#upcoming-page').length > 0) {

    const $table = $('table.table-datatable2');

    const dt = $table.DataTable($.extend(true, {}, dtDefaultOptions, {
        "order": [],
        "pageLength": 100,
        "ajax": function (data, callback, settings) {

            data.search.search = $('#search').val();

            dtDefaultOptions.ajax(data, callback, settings, $(this));
        },
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[3]);
        },
        "drawCallback": function (settings) {
            const api = this.api();
            const rows = api.rows({page: 'current'}).nodes();

            let last = null;
            api.rows().every(function (rowIdx, tableLoop, rowLoop) {
                let group = this.data()[6];
                if (last !== group) {
                    $(rows).eq(rowIdx).before(
                        '<tr class="table-success"><td colspan="3">' + group + '</td></tr>'
                    );
                    last = group;
                }
            });
        },
        "columnDefs": [
            // Icon / Name
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[2] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                },
                "orderable": false,
            },
            // App Type
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[4];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false,
            },
            // Price
            {
                "targets": 2,
                "render": function (data, type, row) {
                    return row[5];
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).attr('nowrap', 'nowrap');
                },
                "orderable": false,
            },
        ]
    }));

    $('form').on('submit', function (e) {

        e.preventDefault();
        dt.search($('#search').val()).draw();
    });
}

const $wishlistsPage = $('#wishlists-page');

if ($wishlistsPage.length > 0) {

    $('#apps table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "order": [[1, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-app-id', data[0]);
            $(row).attr('data-link', data[2]);
        },
        "columnDefs": [
            // Icon / App
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<img src="' + row[4] + '" class="rounded square" alt="' + row[1] + '"><span>' + row[1] + '</span>';
                },
                "createdCell": function (td, cellData, rowData, row, col) {
                    $(td).addClass('img');
                }
            },
            // Count
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[3].toLocaleString();
                },
            },
        ]
    }));

    $('#tags table.table-datatable2').DataTable($.extend(true, {}, dtDefaultOptions, {
        "pageLength": 1000,
        "order": [[1, 'desc']],
        "createdRow": function (row, data, dataIndex) {
            $(row).attr('data-link', data[2]);
        },
        "columnDefs": [
            // Tag
            {
                "targets": 0,
                "render": function (data, type, row) {
                    return '<i class="fas fa-tag"></i> ' + row[1];
                },
            },
            // Count
            {
                "targets": 1,
                "render": function (data, type, row) {
                    return row[3].toLocaleString();
                },
            },
        ]
    }));
}
